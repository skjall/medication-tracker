{% extends "layout.html" %}

{% block title %}{{ _('Physician Visit') }}: {{ format_date(visit.visit_date) }} - {{ _('Medication Tracker') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-hospital me-2"></i>{{ _('Physician Visit Details') }}
    </h1>
    <div>
        <a href="{{ url_for('visits.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>{{ _('Back to List') }}
        </a>
        {% if make_aware(visit.visit_date) >= make_aware(now) %}
            <a href="{{ url_for('visits.edit', id=visit.id) }}" class="btn btn-primary ms-2">
                <i class="fas fa-pen-to-square me-1"></i>{{ _('Edit Visit') }}
            </a>
        {% endif %}
    </div>
</div>

<!-- Visit Details Card -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card {% if make_aware(visit.visit_date) >= make_aware(now) %}border-warning{% endif %} h-100">
            <div class="card-header {% if make_aware(visit.visit_date) >= make_aware(now) %}bg-warning{% else %}bg-primary{% endif %} text-white">
                <h5 class="mb-0">{{ _('Visit Information') }}</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h3 class="d-flex align-items-center">
                        <i class="fas fa-calendar-day me-2 text-primary"></i>
                        {{ format_date(visit.visit_date) }}

                        {% if make_aware(visit.visit_date) >= make_aware(now) %}
                            <span class="badge rounded-pill {% if visit.days_until < 7 %}bg-danger{% elif visit.days_until < 14 %}bg-warning{% else %}bg-success{% endif %} ms-3">
                                {{ visit.days_until }} {{ _('days away') }}
                            </span>
                        {% else %}
                            <span class="badge rounded-pill bg-secondary ms-3">
                                {{ _('Past visit') }}
                            </span>
                        {% endif %}
                    </h3>
                </div>

                <div class="mb-4">
                    <h6><i class="fas fa-user-md me-2"></i>{{ _('Physician') }}:</h6>
                    {% if visit.physician %}
                        <div class="d-flex align-items-center">
                            <div>
                                <strong class="text-primary">{{ visit.physician.name }}</strong>
                                {% if visit.physician.specialty %}
                                    <div class="text-muted">{{ visit.physician.specialty }}</div>
                                {% endif %}
                                {% if visit.physician.phone %}
                                    <div class="small text-muted">
                                        <i class="fas fa-phone me-1"></i>{{ visit.physician.phone }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>{{ _('No physician assigned to this visit.') }}
                        </div>
                    {% endif %}
                </div>

                {% if visit.notes %}
                    <div class="mb-4">
                        <h6>{{ _('Notes') }}:</h6>
                        <p>{{ visit.notes }}</p>
                    </div>
                {% endif %}

                <div class="d-flex justify-content-between mt-4">
                    <small class="text-muted">
                        {{ _('Created') }}: {{ format_datetime(visit.created_at) }}
                        {% if visit.updated_at != visit.created_at %}
                            <br>{{ _('Updated') }}: {{ format_datetime(visit.updated_at) }}
                        {% endif %}
                    </small>

                    {% if make_aware(visit.visit_date) >= make_aware(now) %}
                        <form method="POST" action="{{ url_for('visits.delete', id=visit.id) }}" onsubmit="return confirm('{{ _('Are you sure you want to delete this visit? This cannot be undone.') }}');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash-alt me-1"></i>{{ _('Delete Visit') }}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Associated Orders Card -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ _('Associated Orders') }}</h5>
                    {% if make_aware(visit.visit_date) >= make_aware(now) %}
                        <a href="{{ url_for('orders.new', visit_id=visit.id) }}" class="btn btn-sm btn-light">
                            <i class="fas fa-plus me-1"></i>{{ _('Create Order') }}
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if orders %}
                    <div class="list-group">
                        {% for order in orders %}
                            <a href="{{ url_for('orders.show', id=order.id) }}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ _('Order') }} #{{ order.id }}</h6>
                                    <small class="text-muted">{{ format_date(order.created_date) }}</small>
                                </div>
                                <p class="mb-1">
                                    <span class="badge {% if order.status == 'planned' %}bg-secondary{% elif order.status == 'partial' %}bg-warning{% elif order.status == 'fulfilled' %}bg-success{% endif %}">
                                        {% if order.status == 'planned' %}{{ _('Open') }}{% elif order.status == 'partial' %}{{ _('Partial') }}{% else %}{{ order.status|capitalize }}{% endif %}
                                    </span>
                                </p>
                                <small>
                                    {{ order.order_items|length }} {{ _('medication') }}{{ _('s') if order.order_items|length != 1 }}
                                </small>
                            </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>{{ _('No orders associated with this visit yet.') }}
                    </div>

                    {% if make_aware(visit.visit_date) >= make_aware(now) %}
                        <a href="{{ url_for('orders.new', visit_id=visit.id) }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>{{ _('Create Order') }}
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Medication Needs Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">{{ _('Medication Needs Calculation') }}</h5>
    </div>
    <div class="card-body">
        <p class="mb-4">
            {{ _('Based on your current medication usage and inventory levels, here\'s what you\'ll need until this visit') }}
            ({{ _('plus a safety margin of additional days for each medication') }}).
        </p>

        {% if medication_needs %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Daily Usage') }}</th>
                            <th>{{ _('Safety Margin') }}</th>
                            <th>{{ _('Units Needed') }}</th>
                            <th>{{ _('Current Stock') }}</th>
                            <th>{{ _('Additional Needed') }}</th>
                            <th>{{ _('Packages') }}</th>
                            <th class="text-end">{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med_id, data in medication_needs.items() %}
                            <tr>
                                <td>
                                    <strong>{{ data.medication.name }}</strong>
                                </td>
                                <td>{{ data.medication.daily_usage|round(1) }} {{ _('units') }}</td>
                                <td>{{ data.medication.safety_margin_days }} {{ _('days') }}</td>
                                <td>{{ data.needed_units }}</td>
                                <td>
                                    <span class="{% if data.current_inventory < data.needed_units %}text-danger{% endif %}">
                                        {{ data.current_inventory }}
                                    </span>
                                </td>
                                <td class="{% if data.additional_needed > 0 %}text-danger{% endif %}">
                                    {% if data.additional_needed > 0 %}
                                        <strong>+{{ data.additional_needed }}</strong>
                                    {% else %}
                                        <span class="text-success">{{ _('Sufficient') }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data.additional_needed > 0 %}
                                        <small>
                                            {% if data.packages.N1 > 0 %}
                                                N1: {{ data.packages.N1 }}<br>
                                            {% endif %}
                                            {% if data.packages.N2 > 0 %}
                                                N2: {{ data.packages.N2 }}<br>
                                            {% endif %}
                                            {% if data.packages.N3 > 0 %}
                                                N3: {{ data.packages.N3 }}
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('medications.show', id=data.medication.id) }}" class="btn btn-outline-secondary" title="{{ _('View Medication') }}">
                                            <i class="fas fa-pills"></i>
                                        </a>
                                        {% if data.medication.inventory %}
                                            <a href="{{ url_for('inventory.show', id=data.medication.inventory.id) }}" class="btn btn-outline-primary" title="{{ _('Manage Inventory') }}">
                                                <i class="fas fa-boxes"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ _('No medications found in the system or no inventory data available.') }}
            </div>
        {% endif %}

        {% if medication_needs and make_aware(visit.visit_date) >= make_aware(now) %}
            <div class="mt-4">
                <a href="{{ url_for('orders.new', visit_id=visit.id) }}" class="btn btn-primary">
                    <i class="fas fa-clipboard-list me-1"></i>{{ _('Create Order Based on These Needs') }}
                </a>

                {% set medications_will_deplete = [] %}
                {% set medications_in_safety_margin = [] %}
                {% for med_id, data in medication_needs.items() %}
                    {% if data.is_truly_running_out %}
                        {% set _ = medications_will_deplete.append(data.medication) %}
                    {% elif data.is_in_safety_margin %}
                        {% set _ = medications_in_safety_margin.append(data.medication) %}
                    {% endif %}
                {% endfor %}

                {% if medications_will_deplete or medications_in_safety_margin %}
                    <a href="{{ url_for('orders.new', visit_id=visit.id, gap_coverage='true') }}" class="btn btn-warning ms-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ _('Create Gap Coverage Order') }}
                    </a>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ _('Warning') }}:</strong>
                        {% if medications_will_deplete|length > 0 %}
                            {{ _n('%(count)d medication will run out before this visit.', '%(count)d medications will run out before this visit.', medications_will_deplete|length, count=medications_will_deplete|length) }}
                        {% endif %}
                        {% if medications_in_safety_margin|length > 0 %}
                            {% if medications_will_deplete|length > 0 %} {{ _('Additionally') }}, {% endif %}
                            {{ _n('%(count)d medication is in the safety margin.', '%(count)d medications are in the safety margin.', medications_in_safety_margin|length, count=medications_in_safety_margin|length) }}
                        {% endif %}
                        {{ _('Please consider creating a gap coverage order to bridge the supply gap.') }}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}