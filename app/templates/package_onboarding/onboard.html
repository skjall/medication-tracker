{% extends "layout.html" %}

{% block title %}{{ _('Onboard New Package') }} - {{ _('Medication Tracker') }}{% endblock %}

{% block head_extra %}
<style>
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: 0;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 2px solid #dee2e6;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        position: relative;
    }

    .step.active .step-circle {
        background: var(--bs-primary);
        border-color: var(--bs-primary);
        color: white;
    }

    .step.completed .step-circle {
        background: var(--bs-success);
        border-color: var(--bs-success);
        color: white;
    }

    .step-label {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .step.active .step-label {
        color: var(--bs-primary);
        font-weight: 500;
    }

    .step.completed .step-label {
        color: var(--bs-success);
    }

    .scanned-data-card {
        background: #f8f9fa;
        border-left: 4px solid var(--bs-info);
    }

    .form-section {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .option-card {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .option-card:hover {
        border-color: var(--bs-primary);
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    }

    .option-card.selected {
        border-color: var(--bs-primary);
        background: #f0f8ff;
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-suggestions.show {
        display: block;
    }

    .autocomplete-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
    }

    .autocomplete-item:hover {
        background: #f8f9fa;
    }

    .autocomplete-item.selected {
        background: var(--bs-primary);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-box-open me-2"></i>{{ _('Onboard New Package') }}
        </h1>
        <a href="{{ url_for('scanner.scan') }}" class="btn btn-outline-secondary">
            <i class="fas fa-camera me-1"></i>{{ _('Back to Scanner') }}
        </a>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step-1">
            <div class="step-circle">1</div>
            <div class="step-label">{{ _('Active Ingredient') }}</div>
        </div>
        <div class="step" id="step-2">
            <div class="step-circle">2</div>
            <div class="step-label">{{ _('Product') }}</div>
        </div>
        <div class="step" id="step-3">
            <div class="step-circle">3</div>
            <div class="step-label">{{ _('Package Size') }}</div>
        </div>
        <div class="step" id="step-4">
            <div class="step-circle">4</div>
            <div class="step-label">{{ _('Review & Save') }}</div>
        </div>
    </div>

    <!-- Scanned Data Display -->
    {% if scanned_data.gtin or scanned_data.national_number %}
    <div class="card scanned-data-card mb-4">
        <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">
                <i class="fas fa-barcode me-2"></i>{{ _('Scanned Package Information') }}
            </h6>
            <div class="row">
                {% if scanned_data.gtin %}
                <div class="col-md-3">
                    <small class="text-muted">{{ _('GTIN') }}</small>
                    <div class="fw-bold">{{ scanned_data.gtin }}</div>
                </div>
                {% endif %}
                {% if scanned_data.national_number %}
                <div class="col-md-3">
                    <small class="text-muted">{{ scanned_data.national_number_type or _('National Number') }}</small>
                    <div class="fw-bold">{{ scanned_data.national_number }}</div>
                </div>
                {% endif %}
                {% if scanned_data.batch %}
                <div class="col-md-3">
                    <small class="text-muted">{{ _('Batch') }}</small>
                    <div class="fw-bold">{{ scanned_data.batch }}</div>
                </div>
                {% endif %}
                {% if scanned_data.expiry %}
                <div class="col-md-3">
                    <small class="text-muted">{{ _('Expiry') }}</small>
                    <div class="fw-bold">{{ scanned_data.expiry }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Multi-Step Form -->
    <form method="POST" id="onboardingForm">
        <!-- Step 1: Active Ingredient -->
        <div class="form-section" id="section-1">
            <h4 class="mb-3">{{ _('Step 1: Select or Create Active Ingredient') }}</h4>

            <div class="mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="ingredient_option"
                           id="ingredient_existing" value="existing" checked>
                    <label class="form-check-label" for="ingredient_existing">
                        {{ _('Select Existing Ingredient') }}
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="ingredient_option"
                           id="ingredient_new" value="new">
                    <label class="form-check-label" for="ingredient_new">
                        {{ _('Create New Ingredient') }}
                    </label>
                </div>
            </div>

            <!-- Existing Ingredient Selection -->
            <div id="existing_ingredient_section">
                <div class="position-relative">
                    <input type="text" class="form-control form-control-lg"
                           id="ingredient_search" placeholder="{{ _('Search for active ingredient...') }}">
                    <div class="autocomplete-suggestions" id="ingredient_suggestions"></div>
                </div>
                <input type="hidden" name="ingredient_id" id="ingredient_id">

                <!-- Popular Ingredients -->
                <div class="mt-3">
                    <small class="text-muted">{{ _('Popular ingredients:') }}</small>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        {% for ing in ingredients[:8] %}
                        <button type="button" class="btn btn-sm btn-outline-primary ingredient-quick-select"
                                data-id="{{ ing.id }}" data-name="{{ ing.name }}">
                            {{ ing.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- New Ingredient Form -->
            <div id="new_ingredient_section" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="ingredient_name" class="form-label">{{ _('Ingredient Name') }} *</label>
                        <input type="text" class="form-control" id="ingredient_name"
                               name="ingredient_name" placeholder="{{ _('e.g., Ibuprofen') }}">
                    </div>
                    <div class="col-md-3">
                        <label for="ingredient_strength" class="form-label">{{ _('Strength') }}</label>
                        <input type="text" class="form-control" id="ingredient_strength"
                               name="ingredient_strength" placeholder="{{ _('e.g., 400') }}">
                    </div>
                    <div class="col-md-3">
                        <label for="ingredient_unit" class="form-label">{{ _('Unit') }}</label>
                        <input type="text" class="form-control" id="ingredient_unit"
                               name="ingredient_unit" placeholder="{{ _('e.g., mg') }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Product -->
        <div class="form-section" id="section-2" style="display: none;">
            <h4 class="mb-3">{{ _('Step 2: Select or Create Product') }}</h4>

            <div class="mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="product_option"
                           id="product_existing" value="existing" checked>
                    <label class="form-check-label" for="product_existing">
                        {{ _('Select Existing Product') }}
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="product_option"
                           id="product_new" value="new">
                    <label class="form-check-label" for="product_new">
                        {{ _('Create New Product') }}
                    </label>
                </div>
            </div>

            <!-- Existing Product Selection -->
            <div id="existing_product_section">
                <select class="form-select form-select-lg" name="product_id" id="product_id">
                    <option value="">{{ _('Select a product...') }}</option>
                </select>
            </div>

            <!-- New Product Form -->
            <div id="new_product_section" style="display: none;">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="brand_name" class="form-label">{{ _('Product/Brand Name') }} *</label>
                        <input type="text" class="form-control" id="brand_name"
                               name="brand_name" placeholder="{{ _('e.g., Ibuprofen 1A Pharma') }}">
                    </div>
                    <div class="col-md-6">
                        <label for="manufacturer" class="form-label">{{ _('Manufacturer') }}</label>
                        <input type="text" class="form-control" id="manufacturer"
                               name="manufacturer" placeholder="{{ _('e.g., 1A Pharma') }}">
                    </div>
                </div>

                <!-- Order Settings -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">{{ _('Order Settings') }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="is_otc" name="is_otc">
                            <label class="form-check-label" for="is_otc">
                                {{ _('Over-the-counter (OTC) - No order required') }}
                            </label>
                        </div>

                        <div id="physician_section">
                            <label for="physician_id" class="form-label">{{ _('Prescribing Physician') }}</label>
                            <select class="form-select" id="physician_id" name="physician_id">
                                <option value="">{{ _('Select physician...') }}</option>
                                {% for physician in physicians %}
                                <option value="{{ physician.id }}">{{ physician.display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="aut_idem"
                                   name="aut_idem" checked>
                            <label class="form-check-label" for="aut_idem">
                                {{ _('Allow generic substitution (Aut idem)') }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Package Size -->
        <div class="form-section" id="section-3" style="display: none;">
            <h4 class="mb-3">{{ _('Step 3: Package Configuration') }}</h4>

            <div class="row">
                <div class="col-md-4">
                    <label for="package_size" class="form-label">{{ _('Package Size') }} *</label>
                    <select class="form-select" id="package_size" name="package_size">
                        <option value="N1">N1 - {{ _('Small Package') }}</option>
                        <option value="N2">N2 - {{ _('Medium Package') }}</option>
                        <option value="N3">N3 - {{ _('Large Package') }}</option>
                        <option value="custom">{{ _('Custom Size') }}</option>
                    </select>
                    <input type="text" class="form-control mt-2" id="custom_package_size"
                           name="custom_package_size" placeholder="{{ _('Enter custom size...') }}"
                           style="display: none;">
                </div>
                <div class="col-md-4">
                    <label for="quantity" class="form-label">{{ _('Units per Package') }} *</label>
                    <input type="number" class="form-control" id="quantity" name="quantity"
                           min="1" placeholder="{{ _('e.g., 100') }}" required>
                </div>
                <div class="col-md-4">
                    <label for="list_price" class="form-label">{{ _('List Price') }}</label>
                    <div class="input-group">
                        <span class="input-group-text">€</span>
                        <input type="number" class="form-control" id="list_price"
                               name="list_price" step="0.01" min="0" placeholder="{{ _('0.00') }}">
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="package_manufacturer" class="form-label">{{ _('Package Manufacturer') }}</label>
                    <input type="text" class="form-control" id="package_manufacturer"
                           name="package_manufacturer" placeholder="{{ _('If different from product') }}">
                </div>
            </div>

            <!-- Optional: Link to Inventory -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">{{ _('Inventory Tracking (Optional)') }}</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="link_medication"
                               name="link_medication">
                        <label class="form-check-label" for="link_medication">
                            {{ _('Enable inventory tracking for this product') }}
                        </label>
                    </div>

                    <div id="medication_link_section" style="display: none;">
                        <label for="medication_id" class="form-label">
                            {{ _('Link to existing medication (optional)') }}
                        </label>
                        <select class="form-select" id="medication_id" name="medication_id">
                            <option value="">{{ _('Create new medication record') }}</option>
                            {% for med in medications %}
                            <option value="{{ med.id }}">{{ med.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">
                            {{ _('Leave empty to create a new medication record automatically') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div class="form-section" id="section-4" style="display: none;">
            <h4 class="mb-3">{{ _('Step 4: Review and Save') }}</h4>

            <div class="card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">{{ _('Please review the information') }}</h6>

                    <dl class="row">
                        <dt class="col-sm-3">{{ _('Active Ingredient') }}</dt>
                        <dd class="col-sm-9" id="review_ingredient">-</dd>

                        <dt class="col-sm-3">{{ _('Product') }}</dt>
                        <dd class="col-sm-9" id="review_product">-</dd>

                        <dt class="col-sm-3">{{ _('Package Size') }}</dt>
                        <dd class="col-sm-9" id="review_package">-</dd>

                        <dt class="col-sm-3">{{ _('Order Required') }}</dt>
                        <dd class="col-sm-9" id="review_order">-</dd>

                        <dt class="col-sm-3">{{ _('Barcode Data') }}</dt>
                        <dd class="col-sm-9">
                            {% if scanned_data.gtin %}
                                GTIN: {{ scanned_data.gtin }}<br>
                            {% endif %}
                            {% if scanned_data.national_number %}
                                {{ scanned_data.national_number_type }}: {{ scanned_data.national_number }}
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                <i class="fas fa-arrow-left me-1"></i>{{ _('Previous') }}
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn">
                {{ _('Next') }}<i class="fas fa-arrow-right ms-1"></i>
            </button>
            <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                <i class="fas fa-save me-1"></i>{{ _('Save Package') }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 1;
    const totalSteps = 4;

    // Form data storage
    let formData = {
        ingredient: null,
        product: null,
        package: null
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Step navigation
        document.getElementById('nextBtn').addEventListener('click', nextStep);
        document.getElementById('prevBtn').addEventListener('click', prevStep);

        // Radio button toggles
        document.querySelectorAll('input[name="ingredient_option"]').forEach(radio => {
            radio.addEventListener('change', toggleIngredientSection);
        });

        document.querySelectorAll('input[name="product_option"]').forEach(radio => {
            radio.addEventListener('change', toggleProductSection);
        });

        // OTC checkbox
        document.getElementById('is_otc').addEventListener('change', function() {
            const physicianSection = document.getElementById('physician_section');
            if (this.checked) {
                physicianSection.style.display = 'none';
                document.getElementById('physician_id').value = '';
            } else {
                physicianSection.style.display = 'block';
            }
        });

        // Package size selector
        document.getElementById('package_size').addEventListener('change', function() {
            const customInput = document.getElementById('custom_package_size');
            if (this.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
            }
        });

        // Link medication checkbox
        document.getElementById('link_medication').addEventListener('change', function() {
            const linkSection = document.getElementById('medication_link_section');
            linkSection.style.display = this.checked ? 'block' : 'none';
        });

        // Ingredient search
        setupIngredientSearch();

        // Quick select buttons
        document.querySelectorAll('.ingredient-quick-select').forEach(btn => {
            btn.addEventListener('click', function() {
                selectIngredient(this.dataset.id, this.dataset.name);
            });
        });
    });

    function toggleIngredientSection() {
        const isExisting = document.getElementById('ingredient_existing').checked;
        document.getElementById('existing_ingredient_section').style.display = isExisting ? 'block' : 'none';
        document.getElementById('new_ingredient_section').style.display = isExisting ? 'none' : 'block';
    }

    function toggleProductSection() {
        const isExisting = document.getElementById('product_existing').checked;
        document.getElementById('existing_product_section').style.display = isExisting ? 'block' : 'none';
        document.getElementById('new_product_section').style.display = isExisting ? 'none' : 'block';
    }

    function setupIngredientSearch() {
        const searchInput = document.getElementById('ingredient_search');
        const suggestions = document.getElementById('ingredient_suggestions');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                suggestions.classList.remove('show');
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`{{ url_for('package_onboarding.search_ingredients') }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestions.innerHTML = '';
                        if (data.ingredients.length > 0) {
                            data.ingredients.forEach(ing => {
                                const item = document.createElement('div');
                                item.className = 'autocomplete-item';
                                item.textContent = ing.display;
                                item.dataset.id = ing.id;
                                item.dataset.name = ing.name;
                                item.addEventListener('click', function() {
                                    selectIngredient(this.dataset.id, this.dataset.name);
                                });
                                suggestions.appendChild(item);
                            });
                            suggestions.classList.add('show');
                        } else {
                            suggestions.classList.remove('show');
                        }
                    });
            }, 300);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.remove('show');
            }
        });
    }

    function selectIngredient(id, name) {
        document.getElementById('ingredient_id').value = id;
        document.getElementById('ingredient_search').value = name;
        document.getElementById('ingredient_suggestions').classList.remove('show');
        formData.ingredient = { id: id, name: name };

        // Load products for this ingredient
        loadProductsForIngredient(id);
    }

    function loadProductsForIngredient(ingredientId) {
        fetch(`{{ url_for('package_onboarding.get_ingredient_products', ingredient_id=0) }}`.replace('0', ingredientId))
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('product_id');
                select.innerHTML = '<option value="">{{ _("Select a product...") }}</option>';

                if (data.products.length === 0) {
                    select.innerHTML += '<option value="" disabled>{{ _("No products found - create new") }}</option>';
                    document.getElementById('product_new').checked = true;
                    toggleProductSection();
                } else {
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        if (product.is_default) {
                            option.textContent += ' ⭐';
                        }
                        select.appendChild(option);
                    });
                }
            });
    }

    function validateStep(step) {
        switch(step) {
            case 1:
                // Validate ingredient selection
                if (document.getElementById('ingredient_existing').checked) {
                    const ingredientId = document.getElementById('ingredient_id').value;
                    if (!ingredientId) {
                        alert('{{ _("Please select an active ingredient") }}');
                        return false;
                    }
                } else {
                    const ingredientName = document.getElementById('ingredient_name').value.trim();
                    if (!ingredientName) {
                        alert('{{ _("Please enter an active ingredient name") }}');
                        return false;
                    }
                    formData.ingredient = { name: ingredientName };
                }
                return true;

            case 2:
                // Validate product selection
                if (document.getElementById('product_existing').checked) {
                    const productId = document.getElementById('product_id').value;
                    if (!productId) {
                        alert('{{ _("Please select a product") }}');
                        return false;
                    }
                    formData.product = { id: productId };
                } else {
                    const brandName = document.getElementById('brand_name').value.trim();
                    if (!brandName) {
                        alert('{{ _("Please enter a product name") }}');
                        return false;
                    }
                    formData.product = { name: brandName };
                }
                return true;

            case 3:
                // Validate package configuration
                const packageSize = document.getElementById('package_size').value;
                const quantity = document.getElementById('quantity').value;

                if (packageSize === 'custom') {
                    const customSize = document.getElementById('custom_package_size').value.trim();
                    if (!customSize) {
                        alert('{{ _("Please enter a custom package size") }}');
                        return false;
                    }
                }

                if (!quantity || quantity < 1) {
                    alert('{{ _("Please enter the number of units per package") }}');
                    return false;
                }

                formData.package = {
                    size: packageSize === 'custom' ? document.getElementById('custom_package_size').value : packageSize,
                    quantity: quantity
                };
                return true;

            default:
                return true;
        }
    }

    function updateReviewSection() {
        // Update review display
        document.getElementById('review_ingredient').textContent = formData.ingredient?.name || '-';
        document.getElementById('review_product').textContent = formData.product?.name ||
            document.getElementById('brand_name')?.value || '-';
        document.getElementById('review_package').textContent =
            `${formData.package?.size || '-'} (${formData.package?.quantity || '-'} units)`;

        const isOtc = document.getElementById('is_otc').checked;
        document.getElementById('review_order').textContent =
            isOtc ? '{{ _("No (OTC)") }}' : '{{ _("Yes") }}';
    }

    function nextStep() {
        if (!validateStep(currentStep)) {
            return;
        }

        if (currentStep < totalSteps) {
            // Hide current section
            document.getElementById(`section-${currentStep}`).style.display = 'none';
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            document.getElementById(`step-${currentStep}`).classList.add('completed');

            // Show next section
            currentStep++;
            document.getElementById(`section-${currentStep}`).style.display = 'block';
            document.getElementById(`step-${currentStep}`).classList.add('active');

            // Update buttons
            document.getElementById('prevBtn').style.display = 'inline-block';

            if (currentStep === totalSteps) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'inline-block';
                updateReviewSection();
            }
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            // Hide current section
            document.getElementById(`section-${currentStep}`).style.display = 'none';
            document.getElementById(`step-${currentStep}`).classList.remove('active');

            // Show previous section
            currentStep--;
            document.getElementById(`section-${currentStep}`).style.display = 'block';
            document.getElementById(`step-${currentStep}`).classList.remove('completed');
            document.getElementById(`step-${currentStep}`).classList.add('active');

            // Update buttons
            if (currentStep === 1) {
                document.getElementById('prevBtn').style.display = 'none';
            }

            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('submitBtn').style.display = 'none';
        }
    }
</script>
{% endblock %}