{% extends "layout.html" %} {% block title %}{{ medication.name }} -
{{ _('Medication Tracker') }}{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-pills me-2"></i>{{ medication.name }}
    {% if medication.is_otc %}
      <span class="badge bg-primary text-white ms-2">{{ _('OTC') }}</span>
    {% endif %}
    {% if not medication.aut_idem %}
      <i class="fas fa-fingerprint text-info ms-2" title="{{ _('No generic substitution') }}"></i>
    {% endif %}
  </h1>
  <div>
    <a
      href="{{ url_for('medications.index') }}"
      class="btn btn-outline-secondary"
    >
      <i class="fas fa-arrow-left me-1"></i>{{ _('Back to List') }}
    </a>
    <a
      href="{{ url_for('medications.edit', id=medication.id) }}"
      class="btn btn-primary ms-2"
    >
      <i class="fas fa-pen-to-square me-1"></i>{{ _('Edit') }}
    </a>
  </div>
</div>

<!-- Package Configuration Card -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-qrcode me-2"></i>{{ _('Package Configuration') }}
      </h5>
      <a
        href="{{ url_for('medication_packages.new', medication_id=medication.id) }}"
        class="btn btn-light btn-sm"
      >
        <i class="fas fa-plus me-1"></i>{{ _('Add Package') }}
      </a>
    </div>
  </div>
  <div class="card-body">
    {% if medication.packages %}
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead>
          <tr>
            <th>{{ _('Size') }}</th>
            <th>{{ _('Quantity') }}</th>
            <th>{{ _('National Number') }}</th>
            <th>GTIN</th>
            <th>{{ _('Scanned') }}</th>
            <th>{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for package in medication.packages %}
          <tr>
            <td>
              <strong>{{ package.package_size }}</strong>
            </td>
            <td>{{ package.quantity }} {{ _('units') }}</td>
            <td>
              {% if package.national_number %}
                <code>{{ package.national_number }}</code>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if package.gtin %}
                <small><code>{{ package.gtin }}</code></small>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if package.scanned_items %}
                <span class="badge bg-success">{{ package.scanned_items|length }}</span>
              {% else %}
                <span class="badge bg-secondary">0</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('medication_packages.edit', medication_id=medication.id, package_id=package.id) }}"
                 class="btn btn-sm btn-outline-primary">
                <i class="fas fa-edit"></i>
              </a>
              {% if not package.scanned_items %}
              <form method="POST" action="{{ url_for('medication_packages.delete', medication_id=medication.id, package_id=package.id) }}"
                    class="d-inline" onsubmit="return confirm('{{ _('Are you sure?') }}');">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">{{ _('No packages configured yet. Add package configurations to enable barcode scanning.') }}</p>
    {% endif %}
  </div>
</div>

<!-- Medication Schedule Card - Moved here to make it more prominent -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-calendar-alt me-2"></i>{{ _('Medication Schedule') }}
      </h5>
      <a
        href="{{ url_for('schedules.index', medication_id=medication.id) }}"
        class="btn btn-light btn-sm"
      >
        <i class="fas fa-cog me-1"></i>{{ _('Manage Schedules') }}
      </a>
    </div>
  </div>
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <p class="mb-0">
          <strong>{{ _('Current Status:') }}</strong>
          {% if medication.auto_deduction_enabled %}
          <span class="text-success">
            <i class="fas fa-check-circle"></i> {{ _('Automatic deduction enabled') }}
          </span>
          {% else %}
          <span class="text-secondary">
            <i class="fas fa-times-circle"></i> {{ _('Automatic deduction disabled') }}
          </span>
          {% endif %}
        </p>

        <p class="mt-2 mb-0">
          <strong>{{ _('Daily Usage:') }}</strong> {{
          medication.daily_usage|round(2) }} {{ _('units') }} {% if
          medication.schedules %} ({{ _('based on') }} {{
          medication.schedules|length }} {{ ngettext('%(num)s schedule', '%(num)s schedules', medication.schedules|length, num=medication.schedules|length) }}) {% else %} ({{ _('no schedules defined') }}) {% endif %}
        </p>
      </div>

      <div>
        <form
          method="POST"
          action="{{ url_for('schedules.toggle_auto_deduction', medication_id=medication.id) }}"
        >
          <button
            type="submit"
            class="btn {% if medication.auto_deduction_enabled %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
          >
            {% if medication.auto_deduction_enabled %}
            <i class="fas fa-toggle-off me-1"></i>{{ _('Disable Auto-Deduction') }} {% else %}
            <i class="fas fa-toggle-on me-1"></i>{{ _('Enable Auto-Deduction') }}
            {% endif %}
          </button>
        </form>
      </div>
    </div>

    {% if medication.schedules %}
    <div class="mt-4">
      <h6>{{ _('Active Schedules:') }}</h6>
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>{{ _('Type') }}</th>
              <th>{{ _('Details') }}</th>
              <th>{{ _('Times') }}</th>
              <th>{{ _('Dose') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for schedule in medication.schedules %}
            <tr>
              <td>
                {% if schedule.schedule_type.value == 'daily' %}
                <span class="badge bg-success">{{ _('Daily') }}</span>
                {% elif schedule.schedule_type.value == 'interval' %}
                <span class="badge bg-info"
                  >{{ _('Every') }} {{ schedule.interval_days }} {{ _('day(s)') }}</span
                >
                {% elif schedule.schedule_type.value == 'weekdays' %}
                <span class="badge bg-primary">{{ _('Selected Days of Week') }}</span>
                {% endif %}
              </td>
              <td>
                {% if schedule.schedule_type.value == 'weekdays' %} {%
                set day_names = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri',
                'Sat', 'Sun'] %} {% for day_num in
                schedule.formatted_weekdays %}
                <span class="badge bg-light text-dark"
                  >{{ day_names[day_num] }}</span
                >
                {% endfor %} {% elif schedule.schedule_type.value ==
                'interval' %}
                <span class="text-muted"
                  >{{ _('Every') }} {{ schedule.interval_days }} {{ _('day(s)') }}</span
                >
                {% else %}
                <span class="text-muted">{{ _('Every day') }}</span>
                {% endif %}
              </td>
              <td>
                {% for time in schedule.formatted_times %}
                <span class="badge bg-secondary">{{ time }}</span>
                {% if not loop.last %}<br />{% endif %} {% endfor %}
              </td>
              <td>{{ schedule.units_per_dose }} {{ _('units') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info mt-3">
      <i class="fas fa-info-circle me-2"></i>
      {{ _('No detailed schedules defined yet. Define schedules to enable automatic inventory deduction and precise daily usage calculation.') }}
      <div class="mt-2">
        <a
          href="{{ url_for('schedules.new', medication_id=medication.id) }}"
          class="btn btn-sm btn-primary"
        >
          <i class="fas fa-plus me-1"></i>{{ _('Add First Schedule') }}
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Medication Details Card -->
<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card h-100">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">{{ _('Medication Information') }}</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6>{{ _('Daily Usage:') }}</h6>
            <p>
              {% if medication.daily_usage > 0 %} {{
              medication.daily_usage|round(1) }} {{ _('units per day') }} {% else
              %}
              <span class="text-warning">{{ _('No schedules defined') }}</span>
              {% endif %}
            </p>
          </div>
          <div class="col-md-6">
            <h6>{{ _('Schedules:') }}</h6>
            <p>
              {% if medication.schedules|length > 0 %} {{
              medication.schedules|length }} {{ _('schedule') }}{{ 's' if
              medication.schedules|length != 1 }} {% else %}
              <span class="text-warning">{{ _('None') }}</span>
              {% endif %}
            </p>
          </div>
        </div>

        <h6>{{ _('Daily Usage:') }}</h6>
        <p class="mb-4">
          {{ medication.daily_usage|round(1) }} {{ _('units per day') }}
        </p>

        {% if medication.notes %}
        <h6>{{ _('Notes:') }}</h6>
        <p class="mb-4">{{ medication.notes }}</p>
        {% endif %}

        {% if not medication.packages %}
        <!-- Only show legacy package sizes if no packages are configured -->
        <h6>{{ _('Legacy Package Sizes:') }}</h6>
        <div class="row mb-4">
          {% if medication.package_size_n1 %}
          <div class="col-md-4">
            <div class="package-box n1">
              <strong>N1:</strong> {{ medication.package_size_n1 }}
              {{ _('units') }}
            </div>
          </div>
          {% endif %} {% if medication.package_size_n2 %}
          <div class="col-md-4">
            <div class="package-box n2">
              <strong>N2:</strong> {{ medication.package_size_n2 }}
              {{ _('units') }}
            </div>
          </div>
          {% endif %} {% if medication.package_size_n3 %}
          <div class="col-md-4">
            <div class="package-box n3">
              <strong>N3:</strong> {{ medication.package_size_n3 }}
              {{ _('units') }}
            </div>
          </div>
          {% endif %} {% if not medication.package_size_n1 and not
          medication.package_size_n2 and not
          medication.package_size_n3 %}
          <div class="col-12">
            <p class="text-muted">{{ _('No legacy package sizes defined') }}</p>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <h6>{{ _('Inventory Settings:') }}</h6>
        <div class="row">
          <div class="col-md-6">
            <p>
              <strong>{{ _('Min Threshold:') }}</strong> {{
              medication.min_threshold }} {{ _('units') }}
            </p>
          </div>
          <div class="col-md-6">
            <p>
              <strong>{{ _('Safety Margin:') }}</strong> {{
              medication.safety_margin_days }} {{ _('days') }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Status Card -->
  <div class="col-md-6 mb-4">
    <div
      class="card h-100 {% if medication.inventory and medication.inventory.is_low %}border-danger{% else %}border-success{% endif %}"
    >
      <div
        class="card-header {% if medication.inventory and medication.inventory.is_low %}bg-danger{% else %}bg-success{% endif %} text-white"
      >
        <h5 class="mb-0">{{ _('Inventory Status') }}</h5>
      </div>
      <div class="card-body">
        {% if medication.inventory %}
        <div class="text-center mb-4">
          <div
            class="display-1 {% if medication.inventory.is_low %}text-danger{% else %}text-success{% endif %}"
          >
            {{ medication.total_inventory_count }}
          </div>
          <p class="lead">{{ _('Current Units') }}</p>
          <div class="progress mt-2">
            {% set percent = 100 if not medication.min_threshold else
            (medication.total_inventory_count /
            (medication.min_threshold * 2) * 100)|round %}
            <div
              class="progress-bar {% if medication.inventory.is_low %}bg-danger{% elif percent < 50 %}bg-warning{% else %}bg-success{% endif %}"
              role="progressbar"
              style="width: {{ min(100, percent) }}%"
              aria-valuenow="{{ medication.total_inventory_count }}"
              aria-valuemin="0"
              aria-valuemax="{{ medication.min_threshold * 2 }}"
            ></div>
          </div>
          <small class="text-muted"
            >{{ _('Minimum threshold:') }} {{ medication.min_threshold }}
            {{ _('units') }}</small
          >
        </div>

        <div class="row mb-4">
          <div class="col-md-6 text-center">
            <h3
              class="{% if medication.days_remaining and medication.days_remaining < 30 %}{% if medication.days_remaining < 14 %}text-danger{% else %}text-warning{% endif %}{% endif %}"
            >
              {% if medication.days_remaining %} {{
              medication.days_remaining|round(1) }} {% else %} - {%
              endif %}
            </h3>
            <p>{{ _('Days Remaining') }}</p>
          </div>
          <div class="col-md-6 text-center">
            {% if medication.depletion_date %}
            <h3
              class="{% if medication.days_remaining and medication.days_remaining < 30 %}{% if medication.days_remaining < 14 %}text-danger{% else %}text-warning{% endif %}{% endif %}"
            >
              {{ format_date(medication.depletion_date) }}
            </h3>
            <p>{{ _('Depletion Date') }}</p>
            {% else %}
            <h3>-</h3>
            <p>{{ _('Depletion Date') }}</p>
            {% endif %}
          </div>
        </div>

        <div class="d-grid gap-2">
          <a
            href="{{ url_for('inventory.show', id=medication.inventory.id) }}"
            class="btn btn-primary"
          >
            <i class="fas fa-boxes me-1"></i>{{ _('Manage Inventory') }}
          </a>
        </div>
        {% else %}
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ _('No inventory record found for this medication.') }}
        </div>
        <p>
          {{ _('An inventory record should have been created automatically. Please contact the administrator.') }}
        </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Associated Orders Card -->
<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">{{ _('Order History') }}</h5>
  </div>
  <div class="card-body">
    {% if medication.order_items %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>{{ _('Order #') }}</th>
            <th>{{ _('Visit Date') }}</th>
            <th>{{ _('Order Status') }}</th>
            <th>{{ _('Quantity') }}</th>
            <th>{{ _('Packages') }}</th>
            <th class="text-end">{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for item in medication.order_items %}
          <tr>
            <td>{{ item.order.id }}</td>
            <td>
              {{
              format_date(item.order.physician_visit.visit_date)
              }}
            </td>
            <td>
              <span
                class="badge {% if item.order.status == 'planned' %}bg-primary{% elif item.order.status == 'printed' %}bg-info{% elif item.order.status == 'fulfilled' %}bg-success{% endif %}"
              >
                {{ item.order.status|capitalize }}
              </span>
            </td>
            <td>{{ item.quantity_needed }} {{ _('units') }}</td>
            <td>
              <small>
                {% if item.packages_n1 > 0 %} N1: {{ item.packages_n1
                }}{% if item.packages_n2 > 0 or item.packages_n3 > 0
                %}<br />{% endif %} {% endif %} {% if item.packages_n2
                > 0 %} N2: {{ item.packages_n2 }}{% if
                item.packages_n3 > 0 %}<br />{% endif %} {% endif %}
                {% if item.packages_n3 > 0 %} N3: {{ item.packages_n3
                }} {% endif %}
              </small>
            </td>
            <td class="text-end">
              <a
                href="{{ url_for('orders.show', id=item.order.id) }}"
                class="btn btn-sm btn-outline-primary"
              >
                <i class="fas fa-eye"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i>
      {{ _('No orders found for this medication.') }}
    </div>
    {% endif %}
  </div>
</div>

<!-- Delete Button -->
<div class="mt-4">
  <form
    method="POST"
    action="{{ url_for('medications.delete', id=medication.id) }}"
    onsubmit="return confirm('{{ _('Are you sure you want to delete this medication? This cannot be undone.') }}');"
  >
    <button type="submit" class="btn btn-danger">
      <i class="fas fa-trash-alt me-1"></i>{{ _('Delete Medication') }}
    </button>
  </form>
</div>
{% endblock %}
