{% extends "layout.html" %} {% block title %}{{ _('Add Medication') }}
- {{ _('Medication Tracker') }}{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-plus-circle me-2"></i>{{ _('Add New Medication')
    }}
  </h1>
  <a
    href="{{ url_for('medications.index') }}"
    class="btn btn-outline-primary"
  >
    <i class="fas fa-arrow-left me-1"></i>{{ _('Back to List') }}
  </a>
</div>

<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">{{ _('Medication Information') }}</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('medications.new') }}">
      <div class="row">
        <!-- Basic Information -->
        <div class="col-md-6">
          <h5 class="mb-3">{{ _('Basic Information') }}</h5>

          <div class="mb-3">
            <label for="name" class="form-label"
              >{{ _('Medication Name') }}
              <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            />
          </div>

          <div class="mb-3">
            <label for="active_ingredient" class="form-label"
              >{{ _('Active Ingredient') }}</label
            >
            <input
              type="text"
              class="form-control"
              id="active_ingredient"
              name="active_ingredient"
            />
            <div class="form-text">
              {{ _('The active pharmaceutical ingredient') }}
            </div>
          </div>

          <div class="mb-3">
            <label for="form" class="form-label"
              >{{ _('Form') }}</label
            >
            <input
              type="text"
              class="form-control"
              id="form"
              name="form"
            />
            <div class="form-text">
              {{ _('The pharmaceutical form (e.g., tablets, capsules,
              solution)') }}
            </div>
          </div>

          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="physician_id" class="form-label"
                  >{{ _('Prescribing Physician') }}</label
                >
                <select
                  class="form-select"
                  id="physician_id"
                  name="physician_id"
                >
                  <option value="">
                    {{ _('Select a physician (optional)') }}
                  </option>
                  {% for physician in physicians %}
                  <option value="{{ physician.id }}">
                    {{ physician.display_name }}
                  </option>
                  {% endfor %}
                </select>
                <div class="form-text">
                  {{ _('The physician who prescribes this medication')
                  }}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <div class="form-check mt-4">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="is_otc"
                    name="is_otc"
                    value="1"
                  />
                  <label class="form-check-label" for="is_otc">
                    {{ _('Over-the-Counter (OTC)') }}
                  </label>
                </div>
                <div class="form-text">
                  {{ _('Check if this medication is available without
                  prescription') }}
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="aut_idem"
                    name="aut_idem"
                    value="1"
                    checked
                  />
                  <label class="form-check-label" for="aut_idem">
                    {{ _('Aut idem (Generic substitution allowed)') }}
                  </label>
                </div>
                <div class="form-text">
                  {{ _('Allow pharmacist to substitute with generic equivalent. Uncheck to require exact brand/product.') }}
                </div>
              </div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>{{ _('Important:') }}</strong> {{ _('After
            creating the medication, you\'ll need to set up the
            medication schedule to define when and how much to take.')
            }}
          </div>

          <!-- Hidden fields for backward compatibility -->
          <input type="hidden" name="dosage" value="1" />
          <input type="hidden" name="frequency" value="1" />

          <div class="mb-3">
            <label for="notes" class="form-label"
              >{{ _('Notes') }}</label
            >
            <textarea
              class="form-control"
              id="notes"
              name="notes"
              rows="3"
            ></textarea>
            <div class="form-text">
              {{ _('Optional information about this medication') }}
            </div>
          </div>
        </div>

        <!-- Package Sizes & Thresholds -->
        <div class="col-md-6">
          <h5 class="mb-3">{{ _('Package Sizes') }}</h5>
          <p class="text-muted small">
            {{ _('Enter the number of units/pills in each package size
            (N1, N2, N3)') }}
          </p>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="package_size_n1" class="form-label"
                  >{{ _('N1 Package') }}</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="package_size_n1"
                  name="package_size_n1"
                  min="1"
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="package_size_n2" class="form-label"
                  >{{ _('N2 Package') }}</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="package_size_n2"
                  name="package_size_n2"
                  min="1"
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="package_size_n3" class="form-label"
                  >{{ _('N3 Package') }}</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="package_size_n3"
                  name="package_size_n3"
                  min="1"
                />
              </div>
            </div>
          </div>

          <h5 class="mt-4 mb-3">{{ _('Inventory Settings') }}</h5>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="min_threshold" class="form-label"
                  >{{ _('Minimum Threshold') }}</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="min_threshold"
                  name="min_threshold"
                  min="0"
                  value="30"
                />
                <div class="form-text">
                  {{ _('Alert when stock falls below this level') }}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="safety_margin_days" class="form-label"
                  >{{ _('Safety Margin (days)') }}</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="safety_margin_days"
                  name="safety_margin_days"
                  min="0"
                  value="30"
                />
                <div class="form-text">
                  {{ _('Extra days to add when calculating needs') }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="alert alert-info mt-3">
        <div class="d-flex align-items-center">
          <i class="fas fa-info-circle me-3 fa-2x"></i>
          <div>
            <p class="mb-0">
              <strong
                >{{ _('Next Step: Create Medication Schedule')
                }}</strong
              ><br />
              {{ _('After saving this medication, you\'ll need to
              define when and how much to take using the advanced
              scheduling system. This will determine the daily usage
              and enable automatic inventory tracking.') }}
            </p>
          </div>
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-between">
        <button type="reset" class="btn btn-outline-primary">
          <i class="fas fa-undo me-1"></i>{{ _('Reset') }}
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i>{{ _('Save & Continue to
          Scheduling') }}
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const otcCheckbox = document.getElementById('is_otc');
    const physicianSelect = document.getElementById('physician_id');
    
    // Function to handle OTC checkbox change
    function handleOTCChange() {
        if (otcCheckbox.checked) {
            // OTC selected - disable physician (but keep current value)
            physicianSelect.disabled = true;
            physicianSelect.classList.add('bg-light');
        } else {
            // OTC not selected - enable physician
            physicianSelect.disabled = false;
            physicianSelect.classList.remove('bg-light');
        }
    }
    
    // Add event listener
    otcCheckbox.addEventListener('change', handleOTCChange);
    
    // Check initial state
    handleOTCChange();
});
</script>
{% endblock %}
