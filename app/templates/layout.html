<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Medication Tracker') }}{% endblock %}</title>

    <!-- Bundled vendor styles (Bootstrap, Font Awesome) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/css/vendor.bundle.css') }}">

    <!-- Application styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/css/app.bundle.css') }}">

    {% block head_extra %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='img/logo_header.svg') }}" alt="Medication Tracker Logo" height="30">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>{{ _('Dashboard') }}
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="medicationsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-pills me-1"></i>{{ _('Medications') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('ingredients.index') }}">{{ _('All Medications') }}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('inventory.depletion') }}">{{ _('Depletion Forecast') }}</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="inventoryDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-boxes me-1"></i>{{ _('Inventory') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('inventory.index') }}">{{ _('Inventory Overview') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('inventory.low') }}">{{ _('Low Stock') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('inventory.depletion') }}">{{ _('Depletion Forecast') }}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('scanner.index') }}">{{ _('Scanner') }}</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="physiciansDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-md me-1"></i>{{ _('Physicians') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('physicians.index') }}">{{ _('All Physicians') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('physicians.new') }}">{{ _('Add Physician') }}</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="visitsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-hospital me-1"></i>{{ _('Physician Visits') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('visits.index') }}">{{ _('All Visits') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('visits.new') }}">{{ _('Schedule Visit') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('visits.next_visit') }}">{{ _('Next Visit') }}</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="ordersDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-clipboard-list me-1"></i>{{ _('Orders') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('orders.index') }}">{{ _('All Orders') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('orders.new') }}">{{ _('New Order') }}</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>{{ _('System') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('system.status') }}">{{ _('System Status') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('settings.system') }}">{{ _('System Settings') }}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('pdf_mapper.index') }}">{{ _('PDF Form Templates') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('settings.physician_visits') }}">{{ _('Visit Planning') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('settings.data_management') }}">{{ _('Data Management') }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('system.migrations') }}">{{ _('Database Updates') }}</a></li>

                        </ul>
                    </li>

                    <!-- Language Selector -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-globe me-1"></i>{{ LANGUAGES[CURRENT_LANGUAGE] }}
                        </a>
                        <ul class="dropdown-menu">
                            {% for code, name in LANGUAGES.items() %}
                                <li>
                                    <a class="dropdown-item {% if code == CURRENT_LANGUAGE %}active{% endif %}"
                                       href="{{ url_for('set_language', language=code) }}">
                                        {{ name }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        {% block content %}{% endblock %}
    </div>

    <!-- Modals -->
    {% block modals %}{% endblock %}

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999; margin-top: 70px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set toast_class = 'text-bg-success' if category == 'success' else 'text-bg-danger' if category in ['error', 'danger'] else 'text-bg-warning' if category == 'warning' else 'bg-info text-white' %}
                    {% set icon = 'fa-check-circle' if category == 'success' else 'fa-exclamation-circle' if category in ['error', 'danger'] else 'fa-exclamation-triangle' if category == 'warning' else 'fa-info-circle' %}
                    <div class="toast align-items-center {{ toast_class }} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas {{ icon }} me-2"></i>
                                {{ message }}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{{ _('Close') }}"></button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Footer section for layout.html with local_time fallback
    <footer class="bg-light py-3 mt-auto">
        <div class="container text-center">
            <p class="text-muted mb-0">
                Jan Gro&szlig;heim &copy; {{ now.year }} |
                {{ _('Timezone') }}: {{ settings.timezone_name }} |
                {{ _('Local time') }}: {% if local_time is defined %}{{ format_time(local_time) }}{% else %}{{ format_time(now) }}<sup>*</sup>{% endif %}
            </p>
        </div>
    </footer> -->

    <!-- Bundled vendor JavaScript (jQuery, Bootstrap, Popper) -->
    <script src="{{ url_for('static', filename='dist/js/vendor.bundle.js') }}"></script>

    <!-- Application JavaScript -->
    <script src="{{ url_for('static', filename='dist/js/app.bundle.js') }}"></script>

    <!-- Initialize Toasts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all toasts
            const toastElList = document.querySelectorAll('.toast');
            const toastList = [...toastElList].map(toastEl => {
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
                return toast;
            });

            // Function to show a toast programmatically
            window.showToast = function(message, category = 'info', duration = 5000) {
                const toastContainer = document.querySelector('.toast-container');

                // Determine toast styling based on category
                let toastClass = 'bg-info text-white';
                let icon = 'fa-info-circle';

                if (category === 'success') {
                    toastClass = 'text-bg-success';
                    icon = 'fa-check-circle';
                } else if (category === 'error' || category === 'danger') {
                    toastClass = 'text-bg-danger';
                    icon = 'fa-exclamation-circle';
                } else if (category === 'warning') {
                    toastClass = 'text-bg-warning';
                    icon = 'fa-exclamation-triangle';
                }

                // Create toast HTML
                const toastHtml = `
                    <div class="toast align-items-center ${toastClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="${duration}">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas ${icon} me-2"></i>
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{{ _('Close') }}"></button>
                        </div>
                    </div>
                `;

                // Add toast to container
                const toastElement = document.createElement('div');
                toastElement.innerHTML = toastHtml;
                const toastNode = toastElement.firstElementChild;
                toastContainer.appendChild(toastNode);

                // Initialize and show the toast
                const toast = new bootstrap.Toast(toastNode);
                toast.show();

                // Add hiding animation before removal
                toastNode.addEventListener('hide.bs.toast', function() {
                    toastNode.classList.add('hiding');
                });

                // Remove toast from DOM after it's hidden
                toastNode.addEventListener('hidden.bs.toast', function() {
                    setTimeout(() => {
                        toastNode.remove();
                    }, 300); // Wait for animation to complete
                });
            };
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>