{% extends "layout.html" %}

{% block title %}{{ _('PDF Form Templates') }} - {{ _('Medication Tracker') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-file-pdf me-2"></i>{{ _('PDF Form Templates') }}
        </h1>
        <div>
            <a href="{{ url_for('pdf_mapper.new_template') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>{{ _('New Template') }}
            </a>
        </div>
    </div>

    {% if templates %}
    <div class="row">
        {% for template in templates %}
        <div class="col-12 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="card-title mb-1">
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                {{ template.name }}
                                {% if template.is_default %}
                                <span class="badge bg-primary ms-2">{{ _('Default') }}</span>
                                {% endif %}
                            </h5>
                            {% if template.description %}
                            <p class="card-text text-muted small mb-0">{{ template.description }}</p>
                            {% endif %}
                        </div>

                        <div class="col-md-2 text-center">
                            <div class="text-muted small">{{ _('Rows') }} × {{ _('Columns') }}</div>
                            <div class="fw-bold">{{ template.rows_per_page }} × {{ template.columns_count }}</div>
                        </div>

                        <div class="col-md-2 text-center">
                            <div class="text-muted small">{{ _('Status') }}</div>
                            <div class="fw-bold">
                                {% if not template.file_exists %}
                                    <span class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ _('File missing') }}</span>
                                {% elif template.column_formulas %}
                                    <span class="text-success"><i class="fas fa-check-circle"></i> {{ _('Ready') }}</span>
                                {% elif template.structure_mapping %}
                                    <span class="text-info"><i class="fas fa-cog"></i> {{ _('Structure done') }}</span>
                                {% else %}
                                    <span class="text-warning"><i class="fas fa-exclamation-circle"></i> {{ _('Not configured') }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4 text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                {% if not template.file_exists %}
                                <a href="{{ url_for('pdf_mapper.reupload_template', id=template.id) }}"
                                   class="btn btn-outline-danger" title="{{ _('Re-upload PDF') }}">
                                    <i class="fas fa-upload"></i> {{ _('Re-upload') }}
                                </a>
                                {% else %}
                                <a href="{{ url_for('pdf_mapper.structure_view', id=template.id) }}"
                                   class="btn btn-outline-primary" title="{{ _('Structure') }}">
                                    <i class="fas fa-table"></i>
                                </a>
                                <a href="{{ url_for('pdf_mapper.content_view', id=template.id) }}"
                                   class="btn btn-outline-primary" title="{{ _('Content') }}">
                                    <i class="fas fa-database"></i>
                                </a>
                                {% if template.column_formulas %}
                                <button class="btn btn-outline-primary" title="{{ _('Generate PDF') }}"
                                        onclick="generatePDF({{ template.id }})">
                                    <i class="fas fa-file-export"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-primary" title="{{ _('Import Config') }}"
                                        onclick="importTemplate({{ template.id }}, '{{ template.name }}')">
                                    <i class="fas fa-upload"></i>
                                </button>
                                <button class="btn btn-outline-primary" title="{{ _('Export Config') }}"
                                        onclick="exportTemplate({{ template.id }}, '{{ template.name }}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger" title="{{ _('Delete') }}"
                                        onclick="if(confirm('{{ _('Are you sure you want to delete this template?') }}')) deleteTemplate({{ template.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        {{ _('No PDF templates found. Upload a PDF form to get started.') }}
    </div>
    {% endif %}
</div>

<!-- Import Template Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Import Template Configuration') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="import-template-name"></span>
                </div>
                <div class="mb-3">
                    <label for="importFile" class="form-label">{{ _('Select JSON configuration file') }}</label>
                    <input type="file" class="form-control" id="importFile" accept=".json">
                    <div class="form-text">{{ _('Import a previously exported template configuration to update the structure and content mappings for this template') }}</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="performImport()">
                    <i class="fas fa-upload me-1"></i>{{ _('Import') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Medication Selection Modal -->
<div class="modal fade" id="medicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Select Medications for PDF') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="medication-list">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="generate-btn">
                    <i class="fas fa-file-export me-1"></i>{{ _('Generate PDF') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedTemplateId = null;
let selectedTemplateName = null;

function importTemplate(templateId, templateName) {
    selectedTemplateId = templateId;
    selectedTemplateName = templateName;
    
    // Update modal with template info
    document.getElementById('import-template-name').textContent = 
        '{{ _("Importing configuration for") }}: ' + templateName;
    
    // Clear file input
    document.getElementById('importFile').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

function performImport() {
    const fileInput = document.getElementById('importFile');

    if (!fileInput.files[0]) {
        showToast('{{ _("Please select a file") }}', 'warning');
        return;
    }

    if (!selectedTemplateId) {
        showToast('{{ _("No template selected") }}', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const config = JSON.parse(e.target.result);

            // Send to server
            fetch(`/pdf-mapper/template/${selectedTemplateId}/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('{{ _("Template configuration imported successfully") }}', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.error || '{{ _("Error importing configuration") }}', 'error');
                }
            });
        } catch (err) {
            showToast('{{ _("Invalid JSON file") }}', 'error');
        }
    };
    reader.readAsText(fileInput.files[0]);
}

function exportTemplate(templateId, templateName) {
    fetch(`/pdf-mapper/template/${templateId}/export`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create download link with template name in filename
                const blob = new Blob([JSON.stringify(data.config, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // Sanitize filename
                const safeName = templateName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                a.download = `pdf_template_${safeName}_config.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('{{ _("Template exported successfully") }}', 'success');
            } else {
                showToast(data.error || '{{ _("Error exporting template") }}', 'error');
            }
        });
}

function deleteTemplate(templateId) {
    fetch(`/pdf-mapper/template/${templateId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('{{ _("Template deleted successfully") }}', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || '{{ _("Error deleting template") }}', 'error');
        }
    });
}

function generatePDF(templateId) {
    selectedTemplateId = templateId;

    // Load medications
    fetch('/medications/api/list')
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('medication-list');
            list.innerHTML = '';

            if (data.medications && data.medications.length > 0) {
                const checkboxes = data.medications.map(med => `
                    <div class="form-check">
                        <input class="form-check-input medication-checkbox" type="checkbox"
                               value="${med.id}" id="med_${med.id}">
                        <label class="form-check-label" for="med_${med.id}">
                            ${med.name}
                            ${med.active_ingredient ? `<small class="text-muted">(${med.active_ingredient})</small>` : ''}
                        </label>
                    </div>
                `).join('');

                list.innerHTML = `
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                            {{ _('Select All') }}
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="selectNone()">
                            {{ _('Select None') }}
                        </button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${checkboxes}
                    </div>
                `;
            } else {
                list.innerHTML = '<div class="alert alert-warning">{{ _("No medications found") }}</div>';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('medicationModal'));
            modal.show();
        });
}

function selectAll() {
    document.querySelectorAll('.medication-checkbox').forEach(cb => cb.checked = true);
}

function selectNone() {
    document.querySelectorAll('.medication-checkbox').forEach(cb => cb.checked = false);
}

document.getElementById('generate-btn').addEventListener('click', function() {
    const selectedMeds = Array.from(document.querySelectorAll('.medication-checkbox:checked'))
        .map(cb => parseInt(cb.value));

    if (selectedMeds.length === 0) {
        showToast('{{ _("Please select at least one medication") }}', 'warning');
        return;
    }

    // Generate PDF
    fetch(`/pdf-mapper/template/${selectedTemplateId}/generate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            medication_ids: selectedMeds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Download the generated PDF
            window.location.href = data.download_url;

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('medicationModal')).hide();
            showToast('{{ _("PDF generated successfully!") }}', 'success');
        } else {
            showToast(data.error || '{{ _("Error generating PDF") }}', 'error');
        }
    });
});
</script>
{% endblock %}