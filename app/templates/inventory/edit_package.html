{% extends "layout.html" %}

{% block title %}{{ _('Edit Package') }} - {{ medication.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-box-open me-2"></i>{{ _('Edit Package') }}: {{ medication.name }}
    </h1>
    <div>
        <a href="{{ url_for('inventory.show', id=inventory.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>{{ _('Back to Inventory') }}
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i>{{ _('Package Details') }}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('inventory.edit_package', package_id=package.id) }}">
                    <input type="hidden" name="original_units" value="{{ package.current_units }}">

                    <!-- Package Information -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">{{ _('Package Information') }}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <small class="text-muted d-block">{{ _('Medication') }}</small>
                                    <strong>{{ medication.name }}</strong>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block">{{ _('Package Size') }}</small>
                                    <strong>
                                        {% if scanned_item.package and scanned_item.package.package_size %}
                                            {{ scanned_item.package.package_size }}
                                        {% else %}
                                            N{{ (package.original_units // 10) if package.original_units >= 100 else (1 if package.original_units <= 30 else (2 if package.original_units <= 60 else 3)) }}
                                        {% endif %}
                                    </strong>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block">{{ _('Original Units') }}</small>
                                    <strong>{{ package.original_units }} {{ _('units') }}</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <small class="text-muted d-block">{{ _('Serial Number') }}</small>
                                    <code class="fs-6">{{ scanned_item.serial_number }}</code>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block">{{ _('Batch') }}</small>
                                    {% if scanned_item.batch_number %}
                                        <code class="fs-6">{{ scanned_item.batch_number }}</code>
                                        {% if scanned_item.is_gs1 %}
                                            <small class="text-muted ms-2">({{ _('from GS1') }})</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">{{ _('Not specified') }}</span>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block">{{ _('Expiry Date') }}</small>
                                    {% if scanned_item.expiry_date %}
                                        <span class="{% if scanned_item.expiry_date < today %}text-danger fw-bold{% else %}fw-bold{% endif %}">
                                            {{ scanned_item.expiry_date.strftime('%Y-%m-%d') }}
                                            {% if scanned_item.expiry_date < today %}
                                                <i class="fas fa-exclamation-triangle ms-1"></i>
                                            {% endif %}
                                        </span>
                                        {% if scanned_item.is_gs1 %}
                                            <small class="text-muted ms-2">({{ _('from GS1') }})</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">{{ _('Not specified') }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editable Fields -->
                    {% if not scanned_item.is_gs1 %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">{{ _('Package Details') }} <small>({{ _('Not from GS1 scan - can be edited') }})</small></h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="serial_number" class="form-label">{{ _('Serial Number') }}</label>
                                    <input type="text" class="form-control" id="serial_number" name="serial_number" 
                                           maxlength="100" value="{{ scanned_item.serial_number }}" required
                                           placeholder="{{ _('e.g. SN123456789') }}">
                                    <div class="form-text">{{ _('Unique identifier for this package') }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="batch_number" class="form-label">{{ _('Batch Number') }}</label>
                                    <input type="text" class="form-control" id="batch_number" name="batch_number" 
                                           maxlength="50" value="{{ scanned_item.batch_number or '' }}"
                                           placeholder="{{ _('e.g. LOT123456') }}">
                                    <div class="form-text">{{ _('Enter the batch/lot number from the package') }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="expiry_date" class="form-label">{{ _('Expiry Date') }}</label>
                                    <input type="date" class="form-control" id="expiry_date" name="expiry_date" 
                                           value="{{ scanned_item.expiry_date.strftime('%Y-%m-%d') if scanned_item.expiry_date else '' }}">
                                    <div class="form-text">{{ _('Select the expiry date from the package') }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <label for="status" class="form-label">{{ _('Package Status') }}</label>
                        <select class="form-select" id="status" name="status">
                            <option value="sealed" {% if package.status == 'sealed' %}selected{% endif %}>
                                {{ _('Sealed - Not opened yet') }}
                            </option>
                            <option value="open" {% if package.status == 'open' %}selected{% endif %}>
                                {{ _('Open - In use') }}
                            </option>
                            <option value="empty" {% if package.status == 'empty' %}selected{% endif %}>
                                {{ _('Empty - All units consumed') }}
                            </option>
                            <option value="discarded" {% if package.status == 'discarded' %}selected{% endif %}>
                                {{ _('Discarded - Removed from inventory') }}
                            </option>
                        </select>
                        <div class="form-text">
                            {{ _('Update the status to reflect the current state of the package') }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="current_units" class="form-label">{{ _('Current Units Remaining') }}</label>
                        <div class="input-group input-group-lg mb-2">
                            <button class="btn btn-outline-secondary" type="button" id="decreaseUnits">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center fw-bold" id="current_units" name="current_units"
                                   value="{{ package.current_units }}" min="0" max="{{ package.original_units }}" style="font-size: 1.5rem;">
                            <button class="btn btn-outline-secondary" type="button" id="increaseUnits">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="input-group-text bg-light">/ {{ package.original_units }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            {% set usage_percent = ((package.original_units - package.current_units) / package.original_units * 100)|round if package.original_units > 0 else 0 %}
                            <div class="progress-bar {{ 'bg-success' if usage_percent < 50 else ('bg-warning' if usage_percent < 80 else 'bg-danger') }}" 
                                 role="progressbar" style="width: {{ usage_percent }}%"
                                 aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                {{ usage_percent }}% {{ _('used') }}
                            </div>
                        </div>
                        <div class="form-text">
                            {{ _('Adjust if you have taken medication from this package without updating the system') }}
                        </div>
                    </div>

                    <!-- Quick adjustment buttons -->
                    <div class="mb-4">
                        <label class="form-label">{{ _('Quick Adjustments') }}</label>
                        <div class="row g-2">
                            <div class="col-auto">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary quick-adjust" data-value="-1">
                                        <i class="fas fa-pills me-1"></i>-1
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary quick-adjust" data-value="-5">
                                        <i class="fas fa-pills me-1"></i>-5
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary quick-adjust" data-value="-10">
                                        <i class="fas fa-pills me-1"></i>-10
                                    </button>
                                </div>
                            </div>
                            <div class="col-auto ms-auto">
                                <button type="button" class="btn btn-outline-danger quick-adjust me-2" data-value="0">
                                    <i class="fas fa-box me-1"></i>{{ _('Mark Empty') }}
                                </button>
                                <button type="button" class="btn btn-outline-success quick-adjust" data-value="{{ package.original_units }}">
                                    <i class="fas fa-undo me-1"></i>{{ _('Reset to Full') }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="order_item_id" class="form-label">{{ _('Associated Order') }}</label>
                        <select class="form-select" id="order_item_id" name="order_item_id">
                            <option value="">{{ _('No order association') }}</option>
                            {% if pending_order_items %}
                                <optgroup label="{{ _('Pending Orders') }}">
                                    {% for item in pending_order_items %}
                                        <option value="{{ item.id }}" {% if package.order_item_id == item.id %}selected{% endif %}>
                                            {{ _('Order #%(order_id)s', order_id=item.order.id) }} - 
                                            {{ format_date(item.order.physician_visit.visit_date) }}
                                            ({{ item.packages_n1 + item.packages_n2 + item.packages_n3 }} {{ _('packages') }})
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                            {% if fulfilled_order_items %}
                                <optgroup label="{{ _('Fulfilled Orders') }}">
                                    {% for item in fulfilled_order_items %}
                                        <option value="{{ item.id }}" {% if package.order_item_id == item.id %}selected{% endif %}>
                                            {{ _('Order #%(order_id)s', order_id=item.order.id) }} - 
                                            {{ format_date(item.order.physician_visit.visit_date) }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        </select>
                        <div class="form-text">{{ _('Link this package to a medication order') }}</div>
                    </div>

                    <div class="mb-4">
                        <label for="notes" class="form-label">{{ _('Notes (Optional)') }}</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                                  placeholder="{{ _('Add any notes about this adjustment') }}"></textarea>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>{{ _('Save Changes') }}
                        </button>
                        <a href="{{ url_for('inventory.show', id=inventory.id) }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>{{ _('Cancel') }}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Status Info Card -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">{{ _('Status Information') }}</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>{{ _('Current Status') }}:</strong></p>
                {% if package.status == 'sealed' %}
                    <span class="badge bg-success">{{ _('Sealed') }}</span>
                    <p class="mt-2 mb-0">{{ _('This package has not been opened yet') }}</p>
                {% elif package.status == 'open' %}
                    <span class="badge bg-warning">{{ _('Open') }}</span>
                    <p class="mt-2 mb-0">{{ _('This package is currently in use') }}</p>
                {% elif package.status == 'empty' %}
                    <span class="badge bg-secondary">{{ _('Empty') }}</span>
                    <p class="mt-2 mb-0">{{ _('All units have been consumed') }}</p>
                {% elif package.status == 'discarded' %}
                    <span class="badge bg-danger">{{ _('Discarded') }}</span>
                    <p class="mt-2 mb-0">{{ _('This package has been removed from inventory') }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Usage Info Card -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">{{ _('Usage Information') }}</h6>
            </div>
            <div class="card-body">
                <p><strong>{{ _('Units Used') }}:</strong> {{ package.original_units - package.current_units }} / {{ package.original_units }}</p>
                <div class="progress mb-3">
                    {% set usage_percent = ((package.original_units - package.current_units) / package.original_units * 100)|round %}
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ usage_percent }}%"
                         aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                        {{ usage_percent }}%
                    </div>
                </div>
                <p><strong>{{ _('Scanned') }}:</strong> {{ scanned_item.scanned_at.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const unitsInput = document.getElementById('current_units');
    const statusSelect = document.getElementById('status');
    const maxUnits = {{ package.original_units }};

    // Decrease button
    document.getElementById('decreaseUnits').addEventListener('click', function() {
        const currentValue = parseInt(unitsInput.value) || 0;
        if (currentValue > 0) {
            unitsInput.value = currentValue - 1;
            updateStatus();
        }
    });

    // Increase button
    document.getElementById('increaseUnits').addEventListener('click', function() {
        const currentValue = parseInt(unitsInput.value) || 0;
        if (currentValue < maxUnits) {
            unitsInput.value = currentValue + 1;
            updateStatus();
        }
    });

    // Quick adjust buttons
    document.querySelectorAll('.quick-adjust').forEach(button => {
        button.addEventListener('click', function() {
            const adjustment = parseInt(this.getAttribute('data-value'));
            if (adjustment < 0) {
                // Relative adjustment
                const currentValue = parseInt(unitsInput.value) || 0;
                unitsInput.value = Math.max(0, currentValue + adjustment);
            } else {
                // Absolute value
                unitsInput.value = adjustment;
            }
            updateStatus();
        });
    });

    // Auto-update status based on units
    function updateStatus() {
        const units = parseInt(unitsInput.value) || 0;
        if (units === 0) {
            statusSelect.value = 'empty';
        } else if (units === maxUnits) {
            statusSelect.value = 'sealed';
        } else if (units < maxUnits && statusSelect.value === 'sealed') {
            statusSelect.value = 'open';
        }
    }

    // Update status when units change
    unitsInput.addEventListener('change', updateStatus);
});
</script>
{% endblock %}