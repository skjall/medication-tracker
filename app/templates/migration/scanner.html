{% extends "layout.html" %}

{% block title %}{{ _('Migration Scanner') }} - {{ medication.name }}{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('migration_scanner.select_medication') }}" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-arrow-left"></i> {{ _('Back') }}
                    </a>
                    <span class="h5 mb-0">{{ medication.name }}</span>
                </div>
                <div class="text-end">
                    <div class="h4 mb-0 text-primary">
                        <span class="d-inline d-md-none">
                            <span class="badge bg-primary" id="remainingUnitsMobile">{{ remaining_units }}</span>
                        </span>
                        <span class="d-none d-md-inline">
                            <span id="remainingUnitsDesktop">{{ remaining_units }}</span> {{ _('units left') }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Scanner Column -->
        <div class="col-lg-6 mb-3">
            <div class="card">
                <div class="card-body p-0">
                    <div class="scanner-container position-relative">
                        <video id="scanner-container" class="w-100"></video>
                        <div class="scanner-overlay">
                            <div class="scanner-frame">
                                <div class="corner top-left"></div>
                                <div class="corner top-right"></div>
                                <div class="corner bottom-left"></div>
                                <div class="corner bottom-right"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <!-- Camera controls -->
                    <div class="d-flex justify-content-center gap-2 mb-3">
                        <button type="button" id="toggle-torch-btn" class="btn btn-outline-secondary camera-control-btn" aria-label="Toggle Light" title="{{ _('Toggle Light') }}">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                        <button type="button" id="switch-camera-btn" onclick="switchCamera()" class="btn btn-outline-secondary camera-control-btn" aria-label="Switch Camera" title="{{ _('Switch Camera') }}">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary w-100" id="completeBtn">
                                <i class="fas fa-check me-1"></i>
                                {{ _('Save and close') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packages Column -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-boxes me-2"></i>{{ _('Scanned Packages') }}
                        </span>
                        <span class="badge bg-primary" id="scannedCount">{{ scanned_packages|length }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="packagesList" class="packages-list">
                        {% if not scanned_packages %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p>{{ _('No packages scanned yet') }}</p>
                            <small>{{ _('Start scanning your medication packages') }}</small>
                        </div>
                        {% endif %}
                        {% for package in scanned_packages %}
                        {% set package_serial = package.serial or ('TEMP_' + loop.index0|string) %}
                        <div class="package-item" data-serial="{{ package_serial }}" data-package='{{ package|tojson }}'>
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                                <div>
                                    <strong>
                                        {{ package.package_size }}
                                        <span class="d-inline d-md-none">({{ package.units }})</span>
                                        <span class="d-none d-md-inline">({{ package.units }} {{ _('units') }})</span>
                                    </strong>
                                    {% if package.status == 'opened' %}
                                    <span class="badge bg-warning ms-1">{{ _('Open') }}</span>
                                    {% endif %}
                                    {% if package.serial %}
                                    <small class="text-muted">SN: ...{{ package.serial[-6:] }}</small>
                                    {% endif %}
                                    {% if package.expiry %}
                                    <small class="text-muted d-block">Exp: {{ package.expiry[:10] }}</small>
                                    {% endif %}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editPackage('{{ package_serial }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="undoPackage('{{ package_serial }}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="alert alert-info mt-3">
                <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>{{ _('Tips') }}</h6>
                <ul class="mb-0 small">
                    <li>{{ _('Scan all full packages first') }}</li>
                    <li>{{ _('Add open packages at the end') }}</li>
                    <li>{{ _('Click "Save and close" when finished to complete migration') }}</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Package Onboarding Modal -->
<div class="modal fade" id="onboardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">{{ _('New Package Setup') }}</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <small class="text-muted">{{ _('For') }}: {{ medication.name }}</small>
                </div>
                <div class="mb-2">
                    <small class="text-muted"><span id="modalIdLabel">{{ _('Product Code') }}</span>: <span id="modalPzn"></span></small>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ _('Package Size') }}</label>
                    <select class="form-select" id="modalPackageSize">
                        <option value="N1">N1 ({{ _('Small') }})</option>
                        <option value="N2">N2 ({{ _('Medium') }})</option>
                        <option value="N3">N3 ({{ _('Large') }})</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ _('Units per Package') }} <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="modalUnits" min="1" placeholder="{{ _('Enter package size') }}" required>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="modalIsOpen">
                    <label class="form-check-label" for="modalIsOpen">
                        {{ _('This is an open package') }}
                    </label>
                </div>

                <div class="mb-3" id="openUnitsDiv" style="display: none;">
                    <label class="form-label">{{ _('Units remaining') }}</label>
                    <input type="number" class="form-control" id="modalOpenUnits">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="modalAddBtn" disabled>{{ _('Add Package') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Open Package Modal -->
<div class="modal fade" id="openPackageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">{{ _('Add Open Package') }}</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('Enter details for your open package') }}:</p>

                <div class="mb-3">
                    <label class="form-label">{{ _('Units remaining') }}</label>
                    <input type="number" class="form-control" id="openUnits" value="{{ remaining_units }}">
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ _('Package Size') }}</label>
                    <select class="form-select" id="openPackageSize">
                        <option value="N1">N1</option>
                        <option value="N2" selected>N2</option>
                        <option value="N3">N3</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="addOpenBtn">{{ _('Add') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Package Modal -->
<div class="modal fade" id="editPackageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">{{ _('Edit Package') }}</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSerial">

                <div class="mb-3">
                    <label class="form-label">{{ _('Package Size') }}</label>
                    <input type="text" class="form-control" id="editPackageSize" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ _('Original Units') }}</label>
                    <input type="number" class="form-control" id="editOriginalUnits" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ _('Actual Units in Package') }}</label>
                    <input type="number" class="form-control" id="editActualUnits" min="0">
                    <small class="text-muted">{{ _('Enter the actual number of units in this package') }}</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">{{ _('Save Changes') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Remaining Units Modal -->
<div class="modal fade" id="remainingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">{{ _('Remaining Inventory') }}</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('You still have') }} <strong><span id="remainingUnitsInModal">0</span> {{ _('units') }}</strong> {{ _('of sum-based inventory remaining.') }}</p>
                <p>{{ _('What would you like to do?') }}</p>
            </div>
            <div class="modal-footer flex-column">
                <button type="button" class="btn btn-secondary w-100 mb-2" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i>{{ _('Continue Scanning') }}
                </button>
                <button type="button" class="btn btn-outline-primary w-100 mb-2" id="saveProgressBtn">
                    <i class="fas fa-save me-1"></i>{{ _('Save & Exit') }}
                </button>
                <button type="button" class="btn btn-danger w-100" id="finalizeBtn">
                    <i class="fas fa-check-double me-1"></i>{{ _('Finalize (Set to 0)') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Scanner Video - Full width, auto height */
#scanner-container {
    display: block;
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: cover;
    position: relative;
    z-index: 1;
}

.scanner-container {
    position: relative;
    overflow: visible !important;
}

/* Ensure card doesn't clip buttons */
.card-body.p-0 {
    overflow: visible !important;
}

.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}


.scanner-frame {
    position: relative;
    width: 80%;
    max-width: 300px;
    aspect-ratio: 1;
}

.corner {
    position: absolute;
    width: 30px;
    height: 30px;
    border: 3px solid #28a745;
}

.corner.top-left {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
}

.corner.top-right {
    top: 0;
    right: 0;
    border-left: none;
    border-bottom: none;
}

.corner.bottom-left {
    bottom: 0;
    left: 0;
    border-right: none;
    border-top: none;
}

.corner.bottom-right {
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: none;
}

.scan-hint {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    white-space: nowrap;
}

/* Packages List */
.packages-list {
    max-height: 400px;
    overflow-y: auto;
}

/* Mobile Responsive */
@media (max-width: 991px) {
    #scanner-container {
        max-height: 300px;
    }
}

/* Camera control buttons - simple style below scanner */
.camera-control-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.camera-control-btn.available {
    display: inline-flex;
}

.camera-control-btn i {
    font-size: 18px;
}

#toggle-torch-btn.active {
    background-color: #ffc107;
    border-color: #ffc107;
    color: white;
}

#toggle-torch-btn.active:hover {
    background-color: #ffb300;
    border-color: #ffb300;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const medicationId = {{ medication.id }};
let codeReader = null;
let onboardingData = null;
let isModalOpen = false;
let selectedDeviceId = null;
let availableCameras = [];
let currentStream = null;
let torchCapability = false;

// Update status display
function updateStatus(message, type = 'info') {
    const statusEl = document.getElementById('scanStatus');
    if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `badge bg-${type === 'danger' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'secondary'}`;
    }
}

// Initialize scanner
function initScanner() {
    const hints = new Map();
    // hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    codeReader = new ZXing.BrowserMultiFormatReader(hints);

    codeReader.listVideoInputDevices().then(videoInputDevices => {
        availableCameras = videoInputDevices;
        if (videoInputDevices.length > 0) {
            // Show camera switch button if multiple cameras
            const switchBtn = document.getElementById('switch-camera-btn');
            const torchBtn = document.getElementById('toggle-torch-btn');

            if (switchBtn && videoInputDevices.length > 1) {
                switchBtn.classList.add('available');
                // Initially center it (will be adjusted if torch is detected)
                switchBtn.classList.add('centered');
            }

            // Prefer back camera
            const selectedDevice = videoInputDevices.find(device =>
                device.label.toLowerCase().includes('back') ||
                device.label.toLowerCase().includes('environment')
            ) || videoInputDevices[0];

            selectedDeviceId = selectedDevice.deviceId;
            startScanning(selectedDeviceId);
        }
    }).catch(err => {
        console.error('Error accessing camera:', err);
        alert('{{ _("Camera access required for scanning") }}');
    });
}

// Validation function to filter out false positives
function isValidBarcode(code, format) {
    // Must have minimum length
    if (!code || code.length < 6) {
        return false;
    }

    // Check for known pharmaceutical barcode patterns
    // DataMatrix codes typically contain FNC1 or structured data
    if (format === ZXing.BarcodeFormat.DATA_MATRIX) {
        // Should contain GS1 AIs or be alphanumeric with proper structure
        const hasGS1 = code.includes(String.fromCharCode(29)) || // FNC1
                       /\d{2}\d{14}/.test(code) || // GTIN pattern
                       /01\d{14}/.test(code); // AI 01 pattern
        const hasReasonableLength = code.length >= 10;
        return hasGS1 || hasReasonableLength;
    }

    // EAN/UPC validation - be stricter for pharmaceutical context
    if (format === ZXing.BarcodeFormat.EAN_13 ||
        format === ZXing.BarcodeFormat.EAN_8 ||
        format === ZXing.BarcodeFormat.UPC_A) {
        // Must be numeric
        if (!/^\d+$/.test(code)) {
            return false;
        }

        return true;
    }

    // Code 39 (used for PZN) should be alphanumeric
    if (format === ZXing.BarcodeFormat.CODE_39) {
        // PZN format: starts with minus and 7-8 digits
        return /^-?\d{7,8}$/.test(code) || /^[A-Z0-9\-]+$/.test(code);
    }

    // Code 128 can contain various data
    if (format === ZXing.BarcodeFormat.CODE_128) {
        return code.length >= 6 && code.length <= 50;
    }

    // QR codes - filter out URLs and short random text
    if (format === ZXing.BarcodeFormat.QR_CODE) {
        // Reject URLs
        if (/^https?:\/\//i.test(code)) {
            return false;
        }
        // Reject very short codes (likely false positives)
        if (code.length < 8) {
            return false;
        }
        // Accept if it looks like structured data
        return true;
    }

    // Default: accept if reasonable length
    return code.length >= 6 && code.length <= 100;
}

let lastScanTime = 0;
let lastScannedCode = null;
const SCAN_COOLDOWN = 2000; // 2 seconds between same code
let scanActivityTracker = [];  // Track scan attempts for phantom detection
const PHANTOM_THRESHOLD = 5;  // Number of rapid scans to trigger phantom detection
const PHANTOM_TIME_WINDOW = 3000; // Time window in ms to check for rapid scans
let scanMode = 'linear'; // Default to linear mode for migration scanner

// Two-step scanning support
let pendingScan = null; // Store incomplete scan data
let pendingScanTimeout = null; // Timeout for auto-accepting partial data
const PENDING_SCAN_TIMEOUT = 15000; // 15 seconds to complete second scan


function restartScanner() {
    console.log('Restarting scanner to clear phantom state...');

    // First, fully stop and cleanup existing scanner
    if (codeReader) {
        try {
            codeReader.reset();
            codeReader = null;  // Clear the reference
        } catch (e) {
            console.error('Error resetting scanner:', e);
        }
    }

    // Clear all tracking variables
    lastScannedCode = null;
    lastScanTime = 0;
    scanActivityTracker = [];  // Clear activity tracker

    // Wait a moment for cleanup to complete
    setTimeout(() => {
        // Recreate video element
        const scannerContainer = document.getElementById('scanner-container');
        if (scannerContainer) {
            scannerContainer.innerHTML = '<video id="scanner-video" width="100%" height="400"></video>';
        }

        // Reinitialize scanner after a delay
        setTimeout(() => {
            console.log('Reinitializing scanner...');
            initScanner();
        }, 500);
    }, 500);
}

// Make restartScanner globally available
window.restartScanner = restartScanner;

async function startScanning(deviceId) {
    isScanning = true;
    updateStatus('{{ _("Ready to scan") }}', 'success');
    selectedDeviceId = deviceId;

    // Get the video element to check torch capability
    const videoElement = document.getElementById('scanner-container');

    codeReader.decodeFromVideoDevice(deviceId, 'scanner-container', async (result, err) => {
        // Check for torch capability after stream starts
        if (!torchCapability && videoElement && videoElement.srcObject) {
            currentStream = videoElement.srcObject;
            const tracks = currentStream.getVideoTracks();
            if (tracks.length > 0) {
                const track = tracks[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                torchCapability = 'torch' in capabilities;

                // Show/hide torch button based on capability
                const torchBtn = document.getElementById('toggle-torch-btn');
                const switchBtn = document.getElementById('switch-camera-btn');

                if (torchBtn && torchCapability) {
                    torchBtn.classList.add('available');
                    // If torch is available and switch button exists, remove centered class
                    if (switchBtn && switchBtn.classList.contains('available')) {
                        switchBtn.classList.remove('centered');
                    }
                } else if (switchBtn && switchBtn.classList.contains('available')) {
                    // Only switch button is available, center it
                    switchBtn.classList.add('centered');
                }
            }
        }

        if (result) {
            const now = Date.now();

            const code = result.text;
            const format = result.format;

            // Track scan activity for phantom detection (same code repeated rapidly)
            scanActivityTracker.push({time: now, code: code});
            // Remove old entries outside the time window
            scanActivityTracker = scanActivityTracker.filter(scan => now - scan.time < PHANTOM_TIME_WINDOW);

            // Check for phantom reading pattern (same code scanned many times rapidly)
            const sameCodeScans = scanActivityTracker.filter(scan => scan.code === code).length;
            if (sameCodeScans >= PHANTOM_THRESHOLD) {
                console.warn(`Phantom reading detected: same code '${code}' scanned ${sameCodeScans} times in ${PHANTOM_TIME_WINDOW}ms`);
                scanActivityTracker = []; // Clear tracker

                // Auto-restart scanner to clear phantom state
                updateStatus('{{ _("Resetting scanner...") }}', 'warning');
                setTimeout(() => {
                    console.log('Auto-restarting scanner due to phantom readings');
                    restartScanner();
                }, 500);
                return;
            }

            // Log scan details
            console.log('Scan detected:', code);
            console.log('Format:', format);
            console.log('Result points:', result.resultPoints ? result.resultPoints.length : 'N/A');

            // Validate barcode
            if (!isValidBarcode(code, format)) {
                console.log('Invalid barcode - ignoring:', code);
                return;
            }

            // Prevent duplicate scans
            if (code === lastScannedCode && (now - lastScanTime) < SCAN_COOLDOWN) {
                console.log('Duplicate scan - ignoring');
                return;
            }

            lastScannedCode = code;
            lastScanTime = now;

            console.log('Valid scan accepted:', code);
            updateStatus('{{ _("Processing...") }}', 'info');
            handleScan(code);
        }

        if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error('Scan error:', err);
        }
    });
}

// Parse DataMatrix locally to detect incomplete scans
function parseDataMatrixLocal(code) {
    const data = {
        scan_source: 'datamatrix'
    };
    
    // Pattern like "1725100010047AB" - expiry date and batch only
    if (/^17\d{6}10/.test(code)) {
        // AI 17: Expiry date (YYMMDD)
        data.expiry = code.substr(2, 6);
        // AI 10: Batch number (after position 8)
        const batchStart = code.indexOf('10') + 2;
        data.batch = code.substr(batchStart);
        
        // This is incomplete - no product ID
        return data;
    }
    
    // Standard GS1 DataMatrix parsing for complete codes
    // Pattern: 01 (GTIN) + 17 (Expiry) + 21 (Serial) + 10 (Batch)
    if (code.startsWith('01')) {
        // AI 01: GTIN (14 digits)
        data.gtin = code.substr(2, 14);
        
        // Look for other AIs
        let pos = 16;
        while (pos < code.length) {
            const ai = code.substr(pos, 2);
            if (ai === '17' && pos + 8 <= code.length) {
                // Expiry date
                data.expiry = code.substr(pos + 2, 6);
                pos += 8;
            } else if (ai === '21') {
                // Serial number (variable length, look for next AI or end)
                let serialEnd = code.length;
                for (let i = pos + 2; i < code.length - 1; i++) {
                    if (/^\d{2}$/.test(code.substr(i, 2))) {
                        serialEnd = i;
                        break;
                    }
                }
                data.serial = code.substr(pos + 2, serialEnd - pos - 2);
                pos = serialEnd;
            } else if (ai === '10') {
                // Batch number (variable length)
                let batchEnd = code.length;
                for (let i = pos + 2; i < code.length - 1; i++) {
                    if (/^\d{2}$/.test(code.substr(i, 2))) {
                        batchEnd = i;
                        break;
                    }
                }
                data.batch = code.substr(pos + 2, batchEnd - pos - 2);
                pos = batchEnd;
            } else {
                pos++;
            }
        }
    }
    
    return data;
}

// Check if scan data is incomplete
function isIncompleteScan(data) {
    const hasProductId = data.gtin || data.national_number;
    const hasBatchInfo = data.batch || data.expiry;

    // If we have batch/expiry but no product ID, it's incomplete
    if (hasBatchInfo && !hasProductId) {
        return 'missing_product';
    }
    
    // For migration scanner, we don't prompt for DataMatrix after linear scan
    // We just accept the package with whatever info we have
    
    return false;
}

// Show pending scan prompt
function showPendingScanPrompt(type, data) {
    let message = '';

    if (type === 'missing_product') {
        message = '{{ _("Incomplete data: Product ID missing. Please scan the EAN/PZN barcode.") }}';
        showToast(message, 'warning', PENDING_SCAN_TIMEOUT);
    }

    // Set timeout to auto-accept partial data
    if (pendingScanTimeout) {
        clearTimeout(pendingScanTimeout);
    }

    pendingScanTimeout = setTimeout(() => {
        if (pendingScan) {
            console.log('Auto-accepting partial scan data');
            processFinalScan(pendingScan);
            pendingScan = null;
        }
    }, PENDING_SCAN_TIMEOUT);
}

// Merge two scans together
function mergeScanData(scan1, scan2) {
    // Merge the data, preferring non-null values
    return {
        gtin: scan1.gtin || scan2.gtin,
        serial: scan1.serial || scan2.serial || `MERGED_${Date.now()}`,
        batch: scan1.batch || scan2.batch,
        expiry: scan1.expiry || scan2.expiry,
        national_number: scan1.national_number || scan2.national_number,
        national_number_type: scan1.national_number_type || scan2.national_number_type,
        merged: true
    };
}

// Process the final scan (either single complete or merged)
function processFinalScan(scanData) {
    // Clear any pending scan state
    if (pendingScanTimeout) {
        clearTimeout(pendingScanTimeout);
        pendingScanTimeout = null;
    }

    // Send to server
    fetch('{{ url_for("migration_scanner.scan_package") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            medication_id: medicationId,
            barcode_data: scanData
        })
    })
    .then(response => response.json())
    .then(handleScanResponse);
}

function handleScan(barcodeText) {
    // Parse 2D barcode data
    const barcodeData = parseBarcodeData(barcodeText);

    // Check if we have a pending scan to merge with
    if (pendingScan) {
        // Clear timeout
        if (pendingScanTimeout) {
            clearTimeout(pendingScanTimeout);
            pendingScanTimeout = null;
        }

        // Merge the scans
        const mergedData = mergeScanData(pendingScan, barcodeData);
        pendingScan = null;

        console.log('Merged scan data:', mergedData);
        showToast('{{ _("Scans merged successfully") }}', 'success');

        // Process the merged data
        processFinalScan(mergedData);
        return;
    }

    // Check if this scan is incomplete
    const incompleteType = isIncompleteScan(barcodeData);
    if (incompleteType) {
        // Store as pending and prompt for second scan
        pendingScan = barcodeData;
        showPendingScanPrompt(incompleteType, barcodeData);
        return;
    }

    // Complete scan - send to server
    fetch('{{ url_for("migration_scanner.scan_package") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            medication_id: medicationId,
            barcode_data: barcodeData
        })
    })
    .then(response => response.json())
    .then(handleScanResponse);
}

function handleScanResponse(data) {
        if (data.silent) {
            // Silently ignore - user hasn't moved package away yet
            return;
        } else if (data.error) {
            if (data.duplicate) {
                showToast('{{ _("Package already scanned") }}', 'warning');
            } else if (data.limit_reached) {
                // Migration limit reached - show completion message
                showToast(data.error, 'success');
                updateStatus('{{ _("Migration Complete") }}', 'success');
                // Optionally disable scanner
                if (codeReader) {
                    codeReader.reset();
                    isScanning = false;
                }
            } else {
                showToast(data.error, 'danger');
            }
        } else if (data.unknown_package) {
            // Show onboarding modal only if not already open
            if (!isModalOpen) {
                onboardingData = data;
                showOnboardingModal(data);
            } else {
                console.log('Modal already open, ignoring new unknown package');
            }
        } else if (data.success) {
            // Package added successfully
            updateUI(data);

            // Check if this was auto-adjusted to an open package
            if (data.package && data.package.status === 'opened' && data.remaining_units === 0) {
                showToast('{{ _("Final package added as open package with remaining units") }}', 'info');
                updateStatus('{{ _("Migration Complete") }}', 'success');
            } else {
                showToast('{{ _("Package added") }}', 'success');
            }
        }
}

function parseBarcodeData(text) {
    // First try local DataMatrix parsing for better incomplete scan detection
    // Migration scanner always tries to parse DataMatrix patterns
    const localParsed = parseDataMatrixLocal(text);
    if (localParsed && (localParsed.gtin || localParsed.batch || localParsed.expiry)) {
        // Use local parsing result
        Object.assign(localParsed, { scan_source: 'datamatrix' });
        return localParsed;
    }
    
    // Parse GS1 DataMatrix format
    const data = {
        scan_source: text.length > 20 ? 'datamatrix' : 'linear' // Guess based on length
    };

    // Common patterns
    const patterns = {
        gtin: /(?:01)(\d{14})/,
        serial: /(?:21)([^\x1D]+)/,
        batch: /(?:10)([^\x1D]+)/,
        expiry: /(?:17)(\d{6})/,
        pzn: /(?:710|711)(\d{7,8})/
    };

    let hasGS1Data = false;
    for (const [key, pattern] of Object.entries(patterns)) {
        const match = text.match(pattern);
        if (match) {
            data[key] = match[1];
            hasGS1Data = true;
        }
    }

    // If no GS1 data found, treat the entire barcode as a generic identifier
    if (!hasGS1Data && text.length > 0) {
        // Check if it's a PZN (Code39 format, may have leading dash)
        if (text.match(/^-?\d{7,8}$/)) {
            // Remove leading dash if present
            data.national_number = text.replace(/^-/, '');
            data.national_number_type = 'DE_PZN';
        }
        // Check if it's an ASIN (10 alphanumeric characters starting with B)
        else if (text.match(/^B[0-9A-Z]{9}$/)) {
            data.national_number = text;
            data.national_number_type = 'ASIN';
        }
        // Check if it's a UPC (12 digits)
        else if (text.match(/^\d{12}$/)) {
            data.national_number = text;
            data.national_number_type = 'UPC';
        }
        // Check if it's an EAN (13 digits)
        else if (text.match(/^\d{13}$/)) {
            data.gtin = '0' + text;  // Pad to 14 digits for GTIN
        }
        // Otherwise store as generic identifier
        else {
            data.national_number = text;
            data.national_number_type = 'OTHER';
        }
    }

    // Format expiry date
    if (data.expiry) {
        const exp = data.expiry;
        data.expiry = `20${exp.substr(0,2)}-${exp.substr(2,2)}-${exp.substr(4,2)}`;
    }

    // Check for PZN
    if (data.pzn) {
        data.national_number = data.pzn;
        data.national_number_type = 'DE_PZN';
        delete data.pzn;
    }

    // Extract PZN from GTIN if it's a German NTIN
    if (data.gtin && !data.national_number) {
        // Check for German NTIN (National Trade Item Number)
        // Structure: 0 + 4150 (GS1-Präfix für PZN) + PZN8 + Prüfziffer
        if (data.gtin.startsWith('04150')) {
            // Extract PZN from positions 5-13 (8 digits)
            data.national_number = data.gtin.substring(5, 13);
            data.national_number_type = 'DE_PZN';
        }
    }

    return data;
}

function showOnboardingModal(data) {
    // Show PZN if available, otherwise GTIN
    let displayId = 'N/A';
    let labelText = '{{ _("Product Code") }}';

    if (data.national_number) {
        // Just show the number without the type prefix
        displayId = data.national_number;
        if (data.national_number_type === 'DE_PZN') {
            labelText = 'PZN';
        } else if (data.national_number_type) {
            labelText = data.national_number_type;
        }
    } else if (data.gtin) {
        displayId = data.gtin;
        labelText = 'GTIN';
    }

    document.getElementById('modalPzn').textContent = displayId;
    document.getElementById('modalIdLabel').textContent = labelText;

    // Reset form fields
    document.getElementById('modalUnits').value = '';
    document.getElementById('modalAddBtn').disabled = true;
    document.getElementById('modalIsOpen').checked = false;
    document.getElementById('openUnitsDiv').style.display = 'none';
    document.getElementById('modalOpenUnits').value = '';

    const modalEl = document.getElementById('onboardModal');
    const modal = new bootstrap.Modal(modalEl);

    // Set flag when modal opens
    isModalOpen = true;

    // Reset flag when modal closes
    modalEl.addEventListener('hidden.bs.modal', function () {
        isModalOpen = false;
        onboardingData = null;
    }, { once: true });

    modal.show();
}

function updateUI(data) {
    // Update remaining units for both mobile and desktop
    const remainingMobile = document.getElementById('remainingUnitsMobile');
    const remainingDesktop = document.getElementById('remainingUnitsDesktop');
    if (remainingMobile) remainingMobile.textContent = data.remaining_units;
    if (remainingDesktop) remainingDesktop.textContent = data.remaining_units;

    // Update suggested units if element exists
    const suggestedEl = document.getElementById('suggestedUnits');
    if (suggestedEl) {
        suggestedEl.textContent = data.remaining_units;
    }

    document.getElementById('scannedCount').textContent = data.total_scanned;

    // Remove empty state if exists
    const emptyState = document.querySelector('#packagesList .text-center');
    if (emptyState) {
        emptyState.remove();
    }

    // Add package to list
    if (data.package) {
        addPackageToList(data.package);
    }

    // Check if should suggest open package
    const openPkgBtn = document.getElementById('openPackageBtn');
    if (openPkgBtn && data.remaining_units > 0 && data.remaining_units < 50) {
        openPkgBtn.classList.add('btn-warning');
        openPkgBtn.classList.remove('btn-outline-primary');
    }
}

function addPackageToList(package) {
    // Get last 6 characters of serial if available
    const serialSuffix = package.serial ? '...' + package.serial.slice(-6) : '';

    // Generate a consistent serial identifier (same logic as server template)
    const packageSerial = package.serial || `TEMP_${document.getElementById('packagesList').children.length}`;

    const html = `
        <div class="package-item" data-serial="${packageSerial}" data-package='${JSON.stringify(package)}'>
            <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                <div>
                    <strong>
                        ${package.package_size}
                        <span class="d-inline d-md-none">(${package.units})</span>
                        <span class="d-none d-md-inline">(${package.units} units)</span>
                    </strong>
                    ${package.status === 'opened' ? '<span class="badge bg-warning ms-1">Open</span>' : ''}
                    ${serialSuffix ? '<small class="text-muted">SN: ' + serialSuffix + '</small>' : ''}
                    ${package.expiry ? '<small class="text-muted d-block">Exp: ' + package.expiry.substring(0, 10) + '</small>' : ''}
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editPackage('${packageSerial}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="undoPackage('${packageSerial}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('packagesList').insertAdjacentHTML('beforeend', html);
}

function undoPackage(serial) {
    console.log('Removing package with serial:', serial);
    fetch('{{ url_for("migration_scanner.undo_package") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            medication_id: medicationId,
            serial: serial
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Package removed successfully, remaining:', data.remaining_units);

            // Remove from UI
            const packageElement = document.querySelector(`[data-serial="${serial}"]`);
            if (packageElement) {
                packageElement.remove();
            }

            // Update UI with new data
            updateUI(data);

            // If packages were returned, rebuild the list to show correct statuses
            if (data.packages && data.packages.length > 0) {
                // Clear and rebuild the packages list
                const packagesList = document.getElementById('packagesList');
                packagesList.innerHTML = '';

                data.packages.forEach(pkg => {
                    addPackageToList(pkg);
                });
            }

            showToast('{{ _("Package removed") }}', 'info');

            // Check if list is now empty
            if (document.getElementById('packagesList').children.length === 0) {
                document.getElementById('packagesList').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>{{ _('No packages scanned yet') }}</p>
                        <small>{{ _('Start scanning your medication packages') }}</small>
                    </div>
                `;
            }
        } else {
            console.error('Failed to remove package:', data.error);
            showToast(data.error || '{{ _("Failed to remove package") }}', 'danger');
        }
    })
    .catch(error => {
        console.error('Error removing package:', error);
        showToast('{{ _("Error removing package") }}', 'danger');
    });
}

function showToast(message, type) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    // Add to container
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    container.appendChild(toast);

    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Event handlers
// Enable/disable add button based on units input
document.getElementById('modalUnits').addEventListener('input', function() {
    const value = parseInt(this.value);
    const addBtn = document.getElementById('modalAddBtn');
    addBtn.disabled = !value || value < 1;
});

document.getElementById('modalIsOpen').addEventListener('change', function() {
    document.getElementById('openUnitsDiv').style.display = this.checked ? 'block' : 'none';
});

document.getElementById('modalAddBtn').addEventListener('click', function() {
    const packageSize = parseInt(document.getElementById('modalUnits').value);
    const remainingUnits = parseInt(document.getElementById('remainingUnitsMobile')?.textContent ||
                                     document.getElementById('remainingUnitsDesktop')?.textContent || 0);

    // Check if manually marked as open
    const manuallyOpen = document.getElementById('modalIsOpen').checked;
    const manualUnits = manuallyOpen ? parseInt(document.getElementById('modalOpenUnits').value) : packageSize;

    // Auto-determine if it's an open package: if remaining < package size
    let actualUnits = manualUnits;
    let isOpen = manuallyOpen;

    if (!manuallyOpen && remainingUnits < packageSize) {
        // Auto-detect as open package
        actualUnits = remainingUnits;
        isOpen = true;
    }

    fetch('{{ url_for("migration_scanner.onboard_migration_package") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            medication_id: medicationId,
            ...onboardingData,
            package_size: document.getElementById('modalPackageSize').value,
            units: packageSize,
            actual_units: actualUnits,
            product_name: '{{ medication.name }}',
            is_open: isOpen
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Properly hide modal and remove backdrop
            const modalEl = document.getElementById('onboardModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            // Remove any remaining backdrop
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');

            // Reset modal flag
            isModalOpen = false;
            onboardingData = null;

            updateUI(data);
            showToast('{{ _("Package added") }}', 'success');
        } else {
            showToast(data.error || '{{ _("Failed to add package") }}', 'danger');
        }
    })
    .catch(err => {
        console.error('Error adding package:', err);
        showToast('{{ _("Error adding package") }}', 'danger');
    });
});

// Check if openPackageBtn exists before adding listener
const openBtn = document.getElementById('openPackageBtn');
if (openBtn) {
    openBtn.addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('openPackageModal'));
        modal.show();
    });
}

document.getElementById('addOpenBtn').addEventListener('click', function() {
    fetch('{{ url_for("migration_scanner.add_open_package") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            medication_id: medicationId,
            units: parseInt(document.getElementById('openUnits').value),
            package_size: document.getElementById('openPackageSize').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Properly hide modal and remove backdrop
            const modalEl = document.getElementById('openPackageModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            // Remove any remaining backdrop
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');

            updateUI(data);
            showToast('{{ _("Open package added") }}', 'success');
        } else {
            showToast(data.error || '{{ _("Failed to add package") }}', 'danger');
        }
    })
    .catch(err => {
        console.error('Error adding open package:', err);
        showToast('{{ _("Error adding open package") }}', 'danger');
    });
});

document.getElementById('completeBtn').addEventListener('click', function() {
    const remainingUnits = parseInt(document.getElementById('remainingUnitsMobile')?.textContent ||
                                     document.getElementById('remainingUnitsDesktop')?.textContent || 0);

    if (remainingUnits === 0) {
        // No remaining units - just save and complete
        completeMigration();
    } else {
        // Show modal asking what to do with remaining units
        document.getElementById('remainingUnitsInModal').textContent = remainingUnits;
        const modal = new bootstrap.Modal(document.getElementById('remainingModal'));
        modal.show();
    }
});

// Save progress button handler - saves packages and reduces inventory but doesn't zero it
document.getElementById('saveProgressBtn').addEventListener('click', function() {
    // Hide the modal
    const modalEl = document.getElementById('remainingModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) {
        modal.hide();
    }

    // Save progress (creates packages, reduces old inventory by scanned amount)
    fetch(`{{ url_for("migration_scanner.save_migration_progress", medication_id=medication.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        } else if (data.error) {
            showToast(data.error, 'danger');
        }
    })
    .catch(err => {
        console.error('Error saving progress:', err);
        showToast('{{ _("Error saving progress") }}', 'danger');
    });
});

// Finalize button handler - completes migration and sets old inventory to 0
document.getElementById('finalizeBtn').addEventListener('click', function() {
    // Hide the modal
    const modalEl = document.getElementById('remainingModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) {
        modal.hide();
    }
    // Complete the migration (this sets old inventory to 0)
    completeMigration();
});

function completeMigration() {
    fetch(`{{ url_for("migration_scanner.complete_migration", medication_id=medication.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect;
        } else if (data.error) {
            showToast(data.error, 'danger');
        }
    });
}

// Edit package function
function editPackage(serial) {
    const packageEl = document.querySelector(`[data-serial="${serial}"]`);
    if (!packageEl) return;

    const packageData = JSON.parse(packageEl.dataset.package);

    // Populate edit modal
    document.getElementById('editSerial').value = serial;
    document.getElementById('editPackageSize').value = packageData.package_size;
    document.getElementById('editOriginalUnits').value = packageData.units;
    document.getElementById('editActualUnits').value = packageData.units;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editPackageModal'));
    modal.show();
}

// Save edit button handler
document.getElementById('saveEditBtn').addEventListener('click', function() {
    const serial = document.getElementById('editSerial').value;
    const originalUnits = parseInt(document.getElementById('editOriginalUnits').value);
    const actualUnits = parseInt(document.getElementById('editActualUnits').value);
    const isOpen = actualUnits < originalUnits;  // Automatically determine if open

    fetch('{{ url_for("migration_scanner.edit_package") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            medication_id: medicationId,
            serial: serial,
            package_size: document.getElementById('editPackageSize').value,
            original_units: originalUnits,
            actual_units: actualUnits,
            is_open: isOpen
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide modal properly
            const modalEl = document.getElementById('editPackageModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            // Remove any remaining backdrop
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');

            // Update the package in the list
            const packageEl = document.querySelector(`[data-serial="${serial}"]`);
            if (packageEl && data.package) {
                // Update the data attribute
                packageEl.dataset.package = JSON.stringify(data.package);

                // Update the display
                const packageInfo = packageEl.querySelector('.d-flex > div:first-child');
                const serialSuffix = data.package.serial ? '...' + data.package.serial.slice(-6) : '';
                packageInfo.innerHTML = `
                    <strong>
                        ${data.package.package_size}
                        <span class="d-inline d-md-none">(${data.package.units})</span>
                        <span class="d-none d-md-inline">(${data.package.units} units)</span>
                    </strong>
                    ${data.package.status === 'opened' ? '<span class="badge bg-warning ms-1">Open</span>' : ''}
                    ${serialSuffix ? '<small class="text-muted">SN: ' + serialSuffix + '</small>' : ''}
                    ${data.package.expiry ? '<small class="text-muted d-block">Exp: ' + data.package.expiry.substring(0, 10) + '</small>' : ''}
                `;
            }

            updateUI(data);
            showToast('{{ _("Package updated") }}', 'success');
        } else {
            showToast(data.error || '{{ _("Failed to update package") }}', 'danger');
        }
    })
    .catch(err => {
        console.error('Error updating package:', err);
        showToast('{{ _("Error updating package") }}', 'danger');
    });
});

// Initialize on load
// Switch camera function (global for onclick)
window.switchCamera = async function() {
    if (availableCameras.length <= 1) return;

    // Find current camera index
    const currentIndex = availableCameras.findIndex(cam => cam.deviceId === selectedDeviceId);
    const nextIndex = (currentIndex + 1) % availableCameras.length;
    const nextDevice = availableCameras[nextIndex];

    // Reset current scanner
    if (codeReader) {
        codeReader.reset();
    }

    // Clear torch state
    torchCapability = false;
    const torchBtn = document.getElementById('toggle-torch-btn');
    if (torchBtn) {
        torchBtn.classList.remove('active', 'available');
    }

    // Start with new camera
    setTimeout(() => {
        startScanning(nextDevice.deviceId);
    }, 500);
}

// Toggle torch/flashlight
async function toggleTorch() {
    if (!torchCapability || !currentStream) return;

    const tracks = currentStream.getVideoTracks();
    if (tracks.length > 0) {
        const track = tracks[0];
        const torchBtn = document.getElementById('toggle-torch-btn');
        const isActive = torchBtn.classList.contains('active');

        try {
            await track.applyConstraints({
                advanced: [{ torch: !isActive }]
            });

            if (torchBtn) {
                torchBtn.classList.toggle('active');
            }
        } catch (err) {
            console.error('Error toggling torch:', err);
        }
    }
}

// Attach event listeners
document.addEventListener('DOMContentLoaded', () => {
    initScanner();

    // Camera control buttons
    const switchBtn = document.getElementById('switch-camera-btn');
    if (switchBtn) {
        switchBtn.addEventListener('click', switchCamera);
    }

    const torchBtn = document.getElementById('toggle-torch-btn');
    if (torchBtn) {
        torchBtn.addEventListener('click', toggleTorch);
    }
});

// Cleanup on unload
window.addEventListener('beforeunload', () => {
    if (codeReader) {
        codeReader.reset();
    }
});
</script>
{% endblock %}