{% extends "layout.html" %}

{% block title %}{{ _('Data Management') }} - {{ _('Medication Tracker') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-database me-2"></i>{{ _('Data Management') }}
    </h1>
    <a href="{{ url_for('settings.system') }}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-1"></i>{{ _('Back to System Settings') }}
    </a>
</div>

<!-- Quick Actions Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-download fa-3x text-primary mb-3"></i>
                <h6>{{ _('Backup Database') }}</h6>
                <p class="small text-muted">{{ _('Download complete database backup') }}</p>
                <a href="{{ url_for('settings.backup_database') }}" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-download me-1"></i>{{ _('Download Backup') }}
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-upload fa-3x text-success mb-3"></i>
                <h6>{{ _('Restore Database') }}</h6>
                <p class="small text-muted">{{ _('Restore from backup file') }}</p>
                <button type="button" class="btn btn-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#restoreModal">
                    <i class="fas fa-upload me-1"></i>{{ _('Restore Backup') }}
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-bolt fa-3x text-warning mb-3"></i>
                <h6>{{ _('Optimize Database') }}</h6>
                <p class="small text-muted">{{ _('Improve database performance') }}</p>
                <form action="{{ url_for('settings.optimize_db') }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-bolt me-1"></i>{{ _('Optimize Now') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-eraser fa-3x text-danger mb-3"></i>
                <h6>{{ _('Clear Old Logs') }}</h6>
                <p class="small text-muted">{{ _('Free up database space') }}</p>
                <button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
                    <i class="fas fa-eraser me-1"></i>{{ _('Clear Logs') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Database Overview Card -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>{{ _('Database Statistics') }}</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <i class="fas fa-database fa-2x text-info mb-2"></i>
                    <h6>{{ _('Database Info') }}</h6>
                    <p class="mb-1"><strong>{{ _('Size:') }}</strong> {{ db_size }} {{ db_size_unit }}</p>
                    <p class="mb-0"><small class="text-muted">{{ db_path }}</small></p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <i class="fas fa-pills fa-2x text-primary mb-2"></i>
                    <h6>{{ _('Medical Data') }}</h6>
                    <p class="mb-0"><strong>{{ med_count }}</strong> {{ _('Medications') }}</p>
                    <p class="mb-0"><strong>{{ schedule_count }}</strong> {{ _('Schedules') }}</p>
                    <p class="mb-0"><strong>{{ inventory_count }}</strong> {{ _('Inventory Items') }}</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <i class="fas fa-user-md fa-2x text-success mb-2"></i>
                    <h6>{{ _('Clinical Data') }}</h6>
                    <p class="mb-0"><strong>{{ physician_count }}</strong> {{ _('Physicians') }}</p>
                    <p class="mb-0"><strong>{{ visit_count }}</strong> {{ _('Visits') }}</p>
                    <p class="mb-0"><strong>{{ order_count }}</strong> {{ _('Orders') }}</p>
                </div>
            </div>
        </div>
        {% if inventory_logs_count %}
        <div class="alert alert-info mt-3 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>{{ inventory_logs_count }}</strong> {{ _('inventory log entries in database. Consider clearing old logs to save space.') }}
        </div>
        {% endif %}
    </div>
</div>

<!-- Data Import/Export Card -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>{{ _('Import & Export Data') }}</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>{{ _('Data Type') }}</th>
                        <th>{{ _('Description') }}</th>
                        <th>{{ _('Count') }}</th>
                        <th>{{ _('Import') }}</th>
                        <th>{{ _('Export') }}</th>
                        <th>{{ _('Reset') }}</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Medications -->
                    <tr>
                        <td><strong>{{ _('Medications') }}</strong></td>
                        <td>{{ _('Basic medication information (names, dosages, package sizes)') }}</td>
                        <td>{{ med_count }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="medications">
                                <i class="fas fa-file-import me-1"></i>{{ _('Import') }}
                            </button>
                        </td>
                        <td>
                            <a href="{{ url_for('settings.export_data', data_type='medications') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-file-export me-1"></i>{{ _('Export') }}
                            </a>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal" data-reset-type="medications" data-reset-count="{{ med_count }}">
                                <i class="fas fa-trash-alt me-1"></i>{{ _('Reset') }}
                            </button>
                        </td>
                    </tr>

                    <!-- Physicians -->
                    <tr>
                        <td><strong>{{ _('Physicians') }}</strong></td>
                        <td>{{ _('Physician/doctor information (names, specialties, contact details)') }}</td>
                        <td>{{ physician_count }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="physicians">
                                <i class="fas fa-file-import me-1"></i>{{ _('Import') }}
                            </button>
                        </td>
                        <td>
                            <a href="{{ url_for('settings.export_data', data_type='physicians') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-file-export me-1"></i>{{ _('Export') }}
                            </a>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal" data-reset-type="physicians" data-reset-count="{{ physician_count }}">
                                <i class="fas fa-trash-alt me-1"></i>{{ _('Reset') }}
                            </button>
                        </td>
                    </tr>

                    <!-- Schedules -->
                    <tr>
                      <td><strong>{{ _('Schedules') }}</strong></td>
                      <td>{{ _('Medication timing, frequency, and dosages') }}</td>
                      <td>{{ schedule_count }}</td>
                      <td>
                          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="schedules">
                              <i class="fas fa-file-import me-1"></i>Import
                          </button>
                      </td>
                      <td>
                          <a href="{{ url_for('settings.export_data', data_type='schedules') }}" class="btn btn-primary btn-sm">
                              <i class="fas fa-file-export me-1"></i>Export
                          </a>
                      </td>
                      <td>
                          <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal" data-reset-type="schedules" data-reset-count="{{ schedule_count }}">
                              <i class="fas fa-trash-alt me-1"></i>Reset
                          </button>
                      </td>
                  </tr>

                    <!-- Inventory -->
                    <tr>
                        <td><strong>{{ _('Inventory') }}</strong></td>
                        <td>{{ _('Current inventory levels and package counts') }}</td>
                        <td>{{ inventory_count }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="inventory">
                                <i class="fas fa-file-import me-1"></i>{{ _('Import') }}
                            </button>
                        </td>
                        <td>
                            <a href="{{ url_for('settings.export_data', data_type='inventory') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-file-export me-1"></i>{{ _('Export') }}
                            </a>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal" data-reset-type="inventory" data-reset-count="{{ inventory_count }}">
                                <i class="fas fa-trash-alt me-1"></i>{{ _('Reset') }}
                            </button>
                        </td>
                    </tr>

                    <!-- Physician Visits -->
                    <tr>
                        <td><strong>{{ _('Physician Visits') }}</strong></td>
                        <td>{{ _('Scheduled physician visits and appointments') }}</td>
                        <td>{{ visit_count }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="visits">
                                <i class="fas fa-file-import me-1"></i>{{ _('Import') }}
                            </button>
                        </td>
                        <td>
                            <a href="{{ url_for('settings.export_data', data_type='visits') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-file-export me-1"></i>{{ _('Export') }}
                            </a>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal" data-reset-type="visits" data-reset-count="{{ visit_count }}">
                                <i class="fas fa-trash-alt me-1"></i>{{ _('Reset') }}
                            </button>
                        </td>
                    </tr>

                    <!-- Orders -->
                    <tr>
                        <td><strong>{{ _('Orders') }}</strong></td>
                        <td>{{ _('Medication orders for physician visits') }}</td>
                        <td>{{ order_count }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="orders">
                                <i class="fas fa-file-import me-1"></i>{{ _('Import') }}
                            </button>
                        </td>
                        <td>
                            <a href="{{ url_for('settings.export_data', data_type='orders') }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-file-export me-1"></i>{{ _('Export') }}
                            </a>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal" data-reset-type="orders" data-reset-count="{{ order_count }}">
                                <i class="fas fa-trash-alt me-1"></i>{{ _('Reset') }}
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4">
            <div class="alert alert-warning mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>{{ _('Important:') }}</strong> {{ _('Always backup your database before importing data or resetting records. Import operations may create duplicates if not used carefully.') }}
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">{{ _('Import Data') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form id="importForm" action="" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="importInfoText">{{ _('Select a CSV file to import.') }}</span>
                    </div>

                    <div class="mb-3">
                        <label for="file" class="form-label">{{ _('CSV File') }}</label>
                        <input class="form-control" type="file" id="file" name="file" accept=".csv" required>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="override" name="override">
                        <label class="form-check-label" for="override">
                            {{ _('Override existing records') }}
                        </label>
                        <div class="form-text">
                            {{ _('If checked, existing records will be updated. Otherwise, only new records will be added.') }}
                        </div>
                    </div>

                    <div class="accordion" id="importHelpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                    {{ _('CSV Format Help') }}
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#importHelpAccordion">
                                <div class="accordion-body">
                                    <p id="csvFormatHelpText">{{ _('CSV format information will be shown here.') }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Import Data') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restore Database Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreModalLabel">{{ _('Restore Database') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form action="{{ url_for('settings.restore_database') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ _('Critical Warning:') }}</strong> {{ _('Restoring a database will completely replace your current database with the backup file. All current data will be lost!') }}
                    </div>

                    <div class="mb-3">
                        <label for="restore_file" class="form-label">{{ _('Database Backup File') }}</label>
                        <input class="form-control" type="file" id="restore_file" name="restore_file" accept=".db,.sqlite,.sqlite3" required>
                        <div class="form-text">
                            {{ _('Select a database backup file (.db, .sqlite, or .sqlite3)') }}
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirm_restore" name="confirm_restore" required>
                        <label class="form-check-label text-danger" for="confirm_restore">
                            {{ _('I understand that this will permanently replace all current data') }}
                        </label>
                    </div>

                    <div class="alert alert-info">
                        <small>
                            <strong>{{ _('Recommended:') }}</strong> {{ _('Create a backup of your current database before restoring.') }}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-danger">{{ _('Restore Database') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1" aria-labelledby="clearLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearLogsModalLabel">{{ _('Clear Old Inventory Logs') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form action="{{ url_for('settings.clear_logs') }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ _('Warning:') }}</strong> {{ _('This will permanently delete old inventory logs.') }}
                    </div>

                    <div class="mb-3">
                        <label for="days_to_keep" class="form-label">{{ _('Keep logs from the last:') }}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="days_to_keep" name="days_to_keep" value="90" min="30" max="365">
                            <span class="input-group-text">{{ _('days') }}</span>
                        </div>
                        <div class="form-text">
                            {{ _('Logs older than this will be permanently deleted. Minimum: 30 days.') }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-danger">{{ _('Clear Old Logs') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="resetModalLabel">⚠️ {{ _('Reset Data') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form id="resetForm" action="" method="POST">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ _('WARNING:') }}</strong> <span id="resetWarningText">{{ _('This action will delete all data.') }}</span>
                    </div>

                    <p><strong>{{ _('This will permanently delete:') }}</strong></p>
                    <ul id="resetDetailsList">
                        <li>{{ _('All records of this type') }}</li>
                    </ul>

                    <div class="mb-3">
                        <label for="verification_text" class="form-label">{{ _('To confirm, type') }} <strong id="resetVerificationInstruction">reset [type]</strong> {{ _('below:') }}</label>
                        <input type="text" class="form-control" id="verification_text" name="verification_text" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-danger">{{ _('Reset Data') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Import Modal Setup
        const importModal = document.getElementById('importModal');
        if (importModal) {
            importModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const importType = button.getAttribute('data-import-type');

                // Update form action
                const importForm = document.getElementById('importForm');
                importForm.action = "{{ url_for('settings.import_data_type', data_type='TYPE') }}".replace('TYPE', importType);

                // Update modal title
                const modalTitle = importModal.querySelector('.modal-title');
                modalTitle.textContent = `Import ${importType.charAt(0).toUpperCase() + importType.slice(1)} Data`;

                // Update info text based on import type
                const infoText = document.getElementById('importInfoText');
                const csvHelpText = document.getElementById('csvFormatHelpText');

                if (importType === 'medications') {
                    infoText.textContent = 'Import medication data from a CSV file.';
                    csvHelpText.innerHTML = 'Expected columns:<br>Name, Physician ID (optional), Physician Name (optional), Is OTC (optional), Dosage, Frequency, Package Size N1, Package Size N2, Package Size N3, Min Threshold, Safety Margin Days, Notes';
                }
                else if (importType === 'physicians') {
                    infoText.textContent = 'Import physician data from a CSV file.';
                    csvHelpText.innerHTML = 'Expected columns:<br>Name, Specialty (optional), Phone (optional), Email (optional), Address (optional), Notes (optional)';
                }
                else if (importType === 'inventory') {
                    infoText.textContent = 'Import inventory data from a CSV file.';
                    csvHelpText.innerHTML = 'Expected columns:<br>Medication ID or Medication Name, Current Count, Packages N1, Packages N2, Packages N3, Last Updated';
                }
                else if (importType === 'visits') {
                    infoText.textContent = 'Import physician visit data from a CSV file.';
                    csvHelpText.innerHTML = 'Expected columns:<br>Visit Date, Physician ID (optional), Physician Name (optional), Notes, Order For Next-But-One';
                }
                else if (importType === 'orders') {
                    infoText.textContent = 'Import order data from a CSV file.';
                    csvHelpText.innerHTML = 'Expected columns:<br>Order ID, Visit Date, Status, Created Date, Medication, Quantity Needed, Packages N1, Packages N2, Packages N3';
                }
                else if (importType === 'schedules') {
                    infoText.textContent = 'Import medication schedule data from a CSV file.';
                    csvHelpText.innerHTML = 'Expected columns:<br>Medication ID or Medication Name, Schedule Type (daily/interval/weekdays), Interval Days, Weekdays (comma-separated), Times of Day (comma-separated), Units Per Dose';
                }
            });
        }

        // Reset Modal Setup
        const resetModal = document.getElementById('resetModal');
        if (resetModal) {
            resetModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const resetType = button.getAttribute('data-reset-type');
                const resetCount = button.getAttribute('data-reset-count');

                // Update form action
                const resetForm = document.getElementById('resetForm');
                resetForm.action = "{{ url_for('settings.reset_data_type', data_type='TYPE') }}".replace('TYPE', resetType);

                // Update modal title
                const modalTitle = resetModal.querySelector('.modal-title');
                modalTitle.textContent = `Reset ${resetType.charAt(0).toUpperCase() + resetType.slice(1)} Data`;

                // Update warning text
                const warningText = document.getElementById('resetWarningText');
                warningText.textContent = `This action will delete all ${resetType} data (${resetCount} records).`;

                // Update details list
                const detailsList = document.getElementById('resetDetailsList');
                if (resetType === 'medications') {
                    detailsList.innerHTML = '<li>All medication records</li><li>All related inventory records</li><li>All related order items</li>';
                }
                else if (resetType === 'physicians') {
                    detailsList.innerHTML = '<li>All physician records</li><li>Physician references in medications and visits will be cleared</li>';
                }
                else if (resetType === 'inventory') {
                    detailsList.innerHTML = '<li>All inventory records</li><li>All inventory history logs</li>';
                }
                else if (resetType === 'visits') {
                    detailsList.innerHTML = '<li>All physician visit records</li><li>All associated orders</li>';
                }
                else if (resetType === 'orders') {
                    detailsList.innerHTML = '<li>All order records</li><li>All order items</li>';
                }
                else if (resetType === 'schedules') {
                    detailsList.innerHTML = '<li>All medication schedule records</li>';
                }

                // Update verification text instruction
                const verificationInstruction = document.getElementById('resetVerificationInstruction');
                verificationInstruction.textContent = `reset ${resetType}`;
            });
        }
    });
</script>
{% endblock %}