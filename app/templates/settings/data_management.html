{% extends "layout.html" %}

{% block title %}{{ _('Data Management') }} - {{ _('Medication Tracker') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-database me-2"></i>{{ _('Data Management') }}
    </h1>
    <a href="{{ url_for('settings.system') }}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-1"></i>{{ _('Back to System Settings') }}
    </a>
</div>

<!-- Quick Actions Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-download fa-3x text-primary mb-3"></i>
                <h6>{{ _('Backup Database') }}</h6>
                <p class="small text-muted">{{ _('Download complete database backup') }}</p>
                <a href="{{ url_for('settings.backup_database') }}" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-download me-1"></i>{{ _('Download Backup') }}
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-upload fa-3x text-primary mb-3"></i>
                <h6>{{ _('Restore Database') }}</h6>
                <p class="small text-muted">{{ _('Restore from backup file') }}</p>
                <button type="button" class="btn btn-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#restoreModal">
                    <i class="fas fa-upload me-1"></i>{{ _('Restore Backup') }}
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-bolt fa-3x text-warning mb-3"></i>
                <h6>{{ _('Optimize Database') }}</h6>
                <p class="small text-muted">{{ _('Improve database performance') }}</p>
                <form action="{{ url_for('settings.optimize_db') }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-bolt me-1"></i>{{ _('Optimize Now') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-eraser fa-3x text-danger mb-3"></i>
                <h6>{{ _('Clear Old Logs') }}</h6>
                <p class="small text-muted">{{ _('Free up database space') }}</p>
                <button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
                    <i class="fas fa-eraser me-1"></i>{{ _('Clear Logs') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Database Overview Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>{{ _('Database Statistics') }}</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <i class="fas fa-database fa-2x text-info mb-2"></i>
                    <h6>{{ _('Database Info') }}</h6>
                    <p class="mb-1"><strong>{{ _('Size:') }}</strong> {{ db_size }} {{ db_size_unit }}</p>
                    <p class="mb-0"><small class="text-muted">{{ db_path }}</small></p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <i class="fas fa-pills fa-2x text-primary mb-2"></i>
                    <h6>{{ _('Medical Data') }}</h6>
                    <p class="mb-0"><strong>{{ ingredient_count|default(0) }}</strong> {{ _('Active Ingredients') }}</p>
                    <p class="mb-0"><strong>{{ product_count|default(0) }}</strong> {{ _('Products') }}</p>
                    <p class="mb-0"><strong>{{ package_count|default(0) }}</strong> {{ _('Package Inventories') }}</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <i class="fas fa-user-md fa-2x text-success mb-2"></i>
                    <h6>{{ _('Clinical Data') }}</h6>
                    <p class="mb-0"><strong>{{ physician_count }}</strong> {{ _('Physicians') }}</p>
                    <p class="mb-0"><strong>{{ visit_count }}</strong> {{ _('Visits') }}</p>
                    <p class="mb-0"><strong>{{ order_count }}</strong> {{ _('Orders') }}</p>
                </div>
            </div>
        </div>
        {% if inventory_logs_count %}
        <div class="alert alert-info mt-3 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>{{ inventory_logs_count }}</strong> {{ _('inventory log entries in database. Consider clearing old logs to save space.') }}
        </div>
        {% endif %}
    </div>
</div>

<!-- Note: CSV Import/Export removed due to complex data structure -->
<!-- The new ActiveIngredient → MedicationProduct → ProductPackage architecture -->
<!-- is too complex for simple CSV import/export. Use database backup/restore instead. -->

{% endblock %}

{% block modals %}

<!-- Restore Database Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreModalLabel">{{ _('Restore Database') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form action="{{ url_for('settings.restore_database') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ _('Warning:') }}</strong> {{ _('Restoring a database backup will REPLACE ALL CURRENT DATA. This action cannot be undone.') }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="restore_file" class="form-label">{{ _('Database Backup File') }}</label>
                        <input type="file" class="form-control" id="restore_file" name="restore_file" accept=".db,.sqlite,.sqlite3" required>
                        <div class="form-text">{{ _('Select a database backup file (.db, .sqlite, .sqlite3)') }}</div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirm_restore" name="confirm_restore" required>
                        <label class="form-check-label" for="confirm_restore">
                            {{ _('I understand that all current data will be replaced') }}
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-upload me-1"></i>{{ _('Restore Database') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1" aria-labelledby="clearLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearLogsModalLabel">{{ _('Clear Old Logs') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form action="{{ url_for('settings.clear_old_logs') }}" method="POST">
                <div class="modal-body">
                    <p>{{ _('This will clear inventory log entries older than the selected time period.') }}</p>
                    
                    <div class="mb-3">
                        <label for="days_to_keep" class="form-label">{{ _('Keep logs from the last:') }}</label>
                        <select class="form-select" id="days_to_keep" name="days_to_keep" required>
                            <option value="30">{{ _('30 days') }}</option>
                            <option value="60">{{ _('60 days') }}</option>
                            <option value="90" selected>{{ _('90 days') }}</option>
                            <option value="180">{{ _('180 days') }}</option>
                            <option value="365">{{ _('1 year') }}</option>
                        </select>
                    </div>
                    
                    {% if inventory_logs_count %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ _('Currently %(count)s log entries in database', count=inventory_logs_count) }}
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-eraser me-1"></i>{{ _('Clear Old Logs') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}